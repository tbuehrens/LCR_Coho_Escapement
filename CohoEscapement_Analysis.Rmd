---
title: Coho Escapement Analysis
author: Thomas Buehrens 
output:
  html_document:
    fig_caption: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

***

This document was generated on `r format(Sys.time(), '%m/%d/%Y')`.

***


```{r set_options, echo = FALSE, message = FALSE}
options(width = 100)
knitr::opts_chunk$set(message = FALSE)
set.seed(123)
```

# Purpose
Coho salmon Escapement Estimation for Washington State portion of Lower Columbia ESU


# Requirements
All analyses require R software [**(link)**](https://cran.r-project.org/) (v3.4.3) for data retrieval, data processing, and summarizing model results, and Stan software [**(link)**](https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started/) for Hamiltonian Monte Carlo (HMC) simulation.  


# Functions
We also need a couple of helper functions which we will load from the functions folder, which we will load using the walk() function from the purrr package (which we will install if it is not already installed).
```{r load_funcs, results = "hide",echo = FALSE, message = FALSE, warning = FALSE}
wd_functions<-"functions"
sapply(FUN = source, paste(wd_functions, list.files(wd_functions), sep="/"))
```

# Packages
In addition to purr, We also need a few packages that are not included with the base installation of R, so we begin by installing them (only if necessary) and then loading them.
```{r load_pkgs1, message = FALSE, warning = FALSE,results = "hide"}
packages_list<-c(
  "RODBC",
  "reshape",
  #"R2jags",
  "rstan",
  "tidyverse",
  "ggplot2",
  "dplyr",
  "janitor",
  "scales",
  "gridExtra",
  "ggcorrplot",
  "kableExtra"
)
install_or_load_pack(pack = packages_list)
```

# User Inputs
Here we will specify file names, directories, and make some choices regarding the processing of data and the analysis
```{r user inputs, message=FALSE, warning=FALSE, results="hide"}
#directories
#home.dir<-getwd()
#csv.data.dir<-"final data"
#data.dir<-"final data"
#db.dir<-"final data"
#results.dir<-"results"
#code.dir<-"scripts"
#models.dir<-"models"
home.dir<-getwd()
csv.data.dir<-"final data"
data.dir<-"final data"
db.dir<-"final data"
results.dir<-"results"
code.dir<-"scripts"
models.dir<-"models"



#datasets
accdb.name<-"CohoAnalysis_2018_2023.accdb"
#accdb.name<-"CohoAnalysis_2012_2017.accdb"
traphauldata.name<-"TH_dat_02_26_24_w_nflewisabvdam.csv"
frame_file.name<-"Coho_frames_05.02.25_SVP_TB.csv"
RpF_file.name<-"Coho_RpF_03.11.2024_LB_with_Live_Clips_JL.csv"
IMWdata_v2.name<-"IMW_redds_04_29_2024_V2.csv"
IMWdata.name<-"IMW_redds_04.29.2024.csv"


# set data summarization params
years=c(2010:2023)
GRTSdat.date<-"2024-05-02"
assume_Del_Ost_census<-TRUE
assume_Coal_Duncan_census<-TRUE
UpdateGRTSdata<-FALSE
WriteGRTSdata<-FALSE

#model files
stan_model.file<-"CohoEscapement_Model_2_16_2023_zinb.stan"

#model fitting
fit_Stan = FALSE

#HMC params (only applies to stan model; you need to manually tweak for JAGS in Jagsfit function)
chains=4
thin=1
burn=1000
iter=4000
control = list(adapt_delta = 0.8, max_treedepth = 12)

results_name<-"Results_2024-05-04"
```

# Load & Combine Data for Old JAGs Model

Inputs include
1. RpF
2. Trap and Haul (with CRC data)
3. Coho Frames
4. IMW redds
5. The TWS database
6. In the results summary, "TRT_Population_Goals.csv" is also used. 
7. year-specific functions that generate csv files of 2010 and 2011 data since those years are not in TWS

The code:
1. generates 2010 and 2011 formatted summarized GRTS and Index survey data in csv form and puts them in a folder of "GRTSdat".
2. it then queries TWS and generates identically formatted csv files from TWS for years after 2011 and puts them in the same folder.
3. It then call in the rest of the data from the files listed above and formats the data for the JAGS model.
4. Re-summarizing the data for the Stan model occurs below AFTER the JAGS model run section.
```{r data prep, message = FALSE, warning = FALSE,results = "hide"}
#====================================
#Load Population List & Frame Mileage
#====================================
GRTSpops<-data.frame(read_csv(file.path(csv.data.dir,frame_file.name)))#%>%
  # filter(GRTS_Population!="Coal")%>%
  # mutate(Order=ifelse(Order>6,Order-1,Order))
#=====================================
#Query and Organize GRTS Data from TWS
#=====================================
if(UpdateGRTSdata==TRUE){
  if(2010 %in% years){
    GRTSdataprep2010(data.dir=data.dir,frame_file.name=frame_file.name,WriteGRTSdata=WriteGRTSdata)
  }
  if(2011 %in% years){
    GRTSdataprep2011(data.dir=data.dir,frame_file.name=frame_file.name,WriteGRTSdata=WriteGRTSdata)
  }
  GRTSdat<-GRTSdataprep(GRTSpops=GRTSpops,data.dir=data.dir,db.dir=db.dir,accdb.name = accdb.name,years=years[!years%in%c(2010:2011)], write=WriteGRTSdata)
}else{
  #========================
  #Load GRTS Data from CSVs
  #========================
  GRTS_files.dir<-file.path(csv.data.dir,paste0("GRTSdata_",GRTSdat.date))
  files<-list.files(path=GRTS_files.dir)
  GRTS_files<-files[grep("GRTSdat",files)]
  GRTSdat<- do.call("rbind",lapply(GRTS_files,FUN=function(files){read_csv(paste(GRTS_files.dir,"/",files,sep=""))}))
}
#========================================
#Prepare GRTS data for Analysis
#========================================
years=years
yrs<-length(years)
pops<-rep(dim(GRTSpops)[1],yrs)
pops_sites<-matrix(NA,pops[1],yrs)
pops_sites2<-matrix(NA,pops[1],yrs)
p_index<-matrix(NA,pops[1],yrs)
unk_p_index<-matrix(NA,pops[1],yrs)
sites<-matrix(NA,pops[1],yrs)
Y2<-matrix(NA,pops[1],yrs)
Y<-matrix(NA,pops[1],yrs)
mis_miles<-matrix(NA,pops[1],yrs)
GRTS_miles<-matrix(NA,pops[1],yrs)
I_miles<-matrix(NA,pops[1],yrs)
F_miles<-matrix(NA,pops[1],yrs)
Fm<-matrix(NA,pops[1],yrs)
AS<-matrix(NA,pops[1],yrs)
H<-matrix(NA,pops[1],yrs)
MS<-matrix(NA,pops[1],yrs)
Oc<-matrix(NA,pops[1],yrs)
y<-array(NA,dim=c(pops[1],50,yrs))
g<-array(NA,dim=c(pops[1],50,yrs))
#RpF
NON_TWS_redds<-matrix(NA,pops[1],yrs)
n1<-matrix(NA,pops[1],yrs)
n2<-matrix(NA,pops[1],yrs)
m<-matrix(NA,pops[1],yrs)
good_MR_data<-matrix(NA,pops[1],yrs)
Nb_lim<-matrix(NA,pops[1],yrs)
no_MR_data<-matrix(NA,pops[1],yrs)
#Trap and Haul
log_catch_a_M_mu = matrix(0,pops[1],yrs)
catch_a_M_SD =  matrix(0,pops[1],yrs)
log_catch_j_M_mu = matrix(0,pops[1],yrs)
catch_j_M_SD = matrix(0,pops[1],yrs)
TH_a_M = matrix(0,pops[1],yrs)
TH_j_M = matrix(0,pops[1],yrs)
TH_a_UM = matrix(0,pops[1],yrs)
TH_j_UM = matrix(0,pops[1],yrs)
TH_adult_marked_female = matrix(0,pops[1],yrs)
TH_adult_unmarked_female = matrix(0,pops[1],yrs)
#IMW data
sch=array(NA,dim=c(pops[1],10,yrs))
IMW_redd_tot = matrix(0,pops[1],yrs)
IMW_miles = matrix(0,pops[1],yrs)
good_sch_index = matrix(0,pops[1],yrs)
good_sch=array(NA,dim=c(pops[1],10,yrs))
sch_years<-c(NULL)
GRTSdat<-NULL
IMWdat<-NULL
THdat<-NULL
for(i in 1:yrs){
  #load GRTS data
  GRTSdat_filename<-paste0(csv.data.dir,"/GRTSdata_",GRTSdat.date,"/",years[i],"GRTSdat_",GRTSdat.date,".csv")
  GRTSdat<-data.frame(read.csv(GRTSdat_filename))
  GRTSdat<-GRTSdat[order(as.numeric(as.character(GRTSdat$Order))),]
  temp<-paste("y",1:50,sep=".")
  y[,,i]=as.matrix(GRTSdat[colnames(GRTSdat)%in%temp])
  rownames(y)<-GRTSdat$GRTS_Population
  temp3<-paste("g",1:50,sep=".")
  g[,,i]=as.matrix(GRTSdat[colnames(GRTSdat)%in%temp3])
  rownames(g)<-GRTSdat$GRTS_Population
  #load RpF data
  RpF<-NULL
  RpF<-data.frame(read.csv(paste(csv.data.dir,"/",RpF_file.name,sep="")))
  RpF<-RpF[RpF$Year==years[i] & RpF$GRTS_Population%in%GRTSdat$GRTS_Population,]
  GRTSdat<-merge(RpF[,!colnames(RpF)%in%c("comments")],GRTSdat[!colnames(GRTSdat)%in%temp],all=T)
  GRTSdat[is.na(GRTSdat)]<-0
  #load Trap and Hauldata
  THdat<-NULL
  THdat<-data.frame(read.csv(paste(csv.data.dir,"/",traphauldata.name,sep="")))
  THdat<-THdat[THdat$Year==years[i],]
  GRTSdat<-merge(GRTSdat,THdat[,!colnames(THdat)%in%c("comments")],all=T)
  GRTSdat<-GRTSdat[order(as.numeric(as.character(GRTSdat$Order))),]
  #load IMW redd data
  IMWdat<-NULL
  IMWdat<-data.frame(read.csv(paste(csv.data.dir,"/",IMWdata.name,sep="")))
  IMWdat<-IMWdat[IMWdat$Year==years[i],]
  GRTSdat<-merge(GRTSdat,IMWdat,all=T)
  GRTSdat$IMW_miles[is.na(GRTSdat$IMW_miles)]<-0
  GRTSdat<-GRTSdat[order(as.numeric(as.character(GRTSdat$Order))),]
  #CREATE dataframes for JAGS
  #GRTS
  sites[,i]<-GRTSdat$sites
  Y2[,i]=GRTSdat$Y2
  Y[,i]=GRTSdat$Y
  mis_miles[,i]=GRTSdat$mis_miles-as.numeric(as.character(GRTSdat$NON_TWS_redd_miles))-GRTSdat$IMW_miles
  #===========================================
  #make assumption about census in Del and Ost
  #===========================================
  if(assume_Del_Ost_census==T){
    if(years[i]%in%c(2014:years[length(years)])){
      mis_miles[GRTSpops$GRTS_Population%in%c("Delameter_Above Weir","Ostrander_Above Weir"),i]<-0
    }
    if(years[i]%in%c(2010:2013)){
      #remove mileage above culvert on ostrander, remove mileage above Monahan falls and tiny no fish tribs on upper delameter
      mis_miles[GRTSpops$GRTS_Population%in%c("Delameter_Above Weir","Ostrander_Above Weir"),i]<-mis_miles[GRTSpops$GRTS_Population%in%c("Delameter_Above Weir","Ostrander_Above Weir"),i] - c(4.31,7.84)     }
  }
  #============================================
  F_miles[,i]=GRTSdat$F_miles
  GRTS_miles[,i]=GRTSdat$GRTS_miles
  I_miles[,i]=GRTSdat$I_miles+as.numeric(as.character(GRTSdat$NON_TWS_redd_miles))+GRTSdat$IMW_miles
  #females/AS use index plus GRTS 
  Fm[,i]=GRTSdat$Fm+GRTSdat$I.Fm
  AS[,i]=GRTSdat$AS+GRTSdat$I.AS
  #use max of SGS or weir counts where weirs don't appear to be selective for sex
  nonselectiveweirs<-c("Abernathy_Above AFTC","Abernathy","Germany","Mill","Duncan_Above Weir")
  Fm[GRTSdat$GRTS_Population%in%nonselectiveweirs,i]=pmax(Fm[GRTSdat$GRTS_Population%in%nonselectiveweirs,i],GRTSdat$F_weir[GRTSdat$GRTS_Population%in%nonselectiveweirs])
  AS[GRTSdat$GRTS_Population%in%nonselectiveweirs,i]=pmax(AS[GRTSdat$GRTS_Population%in%nonselectiveweirs,i],GRTSdat$A_weir[GRTSdat$GRTS_Population%in%nonselectiveweirs])
  #for H and AS use max of grts or weir
  H[,i]=pmax(GRTSdat$H + GRTSdat%>%mutate(I.H=ifelse(GRTS_Population=="Coal",I.H,0))%>%dplyr::select(I.H)%>%pull(),GRTSdat$H_weir)
  MS[,i]=pmax(GRTSdat$MS + GRTSdat%>%mutate(I.MS=ifelse(GRTS_Population=="Coal",I.MS,0))%>%dplyr::select(I.MS)%>%pull(),GRTSdat$MS_weir)
  #except supplement with index data where census SGS occurred
  H[mis_miles[,i]==0,i]=pmax(H[mis_miles[,i]==0,i],GRTSdat$H[mis_miles[,i]==0]+GRTSdat$I.H[mis_miles[,i]==0])
  MS[mis_miles[,i]==0,i]=pmax(MS[mis_miles[,i]==0,i],GRTSdat$MS[mis_miles[,i]==0]+GRTSdat$I.MS[mis_miles[,i]==0])
  #oc = oc
  Oc[,i]=GRTSdat$OC
  #RpF
  NON_TWS_redds[,i]=GRTSdat$NON_TWS_redds
  n1[,i]=GRTSdat$n1
  n2[,i]=GRTSdat$n2
  m[,i]=GRTSdat$m
  #Create MR, GRTS, and Index Indices for loops,
  for(j in 1:pops[1]){
    #GRTS
    if(sites[j,i]>0 & mis_miles[j,i]>0){
      pops_sites[j,i]<-GRTSdat$Order[j]
    }
    #Index
    if(I_miles[j,i]>0){
      pops_sites2[j,i]<-GRTSdat$Order[j]
    }
    #Index census and NO GRTS, or GRTS and no Index
    if(I_miles[j,i]>0 & sites[j,i]==0 & mis_miles[j,i]==0){
      p_index[j,i]<-1
    }
    if(I_miles[j,i]==0 & sites[j,i]>0){
      p_index[j,i]<-0
    }
    #unknown p_index
    if(is.na(p_index[j,i])){
      unk_p_index[j,i]<-GRTSdat$Order[j]
    }
    #MR
    if(GRTSdat$good_MR_data[j]==1){
      good_MR_data[j,i]<-GRTSdat$Order[j]
    }
  }
  good_MR_data[,i]<-good_MR_data[,i][order(good_MR_data[,i])]
  Nb_lim[,i]=pmax(AS[,i],MS[,i])
  pops_sites[,i]<-pops_sites[,i][order(pops_sites[,i])]
  pops_sites2[,i]<-pops_sites2[,i][order(pops_sites2[,i])]
  unk_p_index[,i]<-unk_p_index[,i][order(unk_p_index[,i])]
  no_MR_data[,i]<-GRTSdat$Order
  no_MR_data[,i][no_MR_data[,i]%in%good_MR_data[,i]]<-NA
  no_MR_data[,i]<-no_MR_data[,i][order(no_MR_data[,i])]
  #Trap and Haul
  log_catch_a_M_mu[,i] = log(GRTSdat$catch_adult_marked_mu)
  catch_a_M_SD[,i] =  sqrt(GRTSdat$catch_adult_marked_var)/(GRTSdat$catch_adult_marked_mu)
  log_catch_j_M_mu[,i] = log(GRTSdat$catch_jack_marked_mu)
  catch_j_M_SD[,i] = sqrt(GRTSdat$catch_jack_marked_var)/(GRTSdat$catch_jack_marked_mu)
  TH_a_M[,i] = GRTSdat$TH_adult_marked
  TH_j_M[,i] = GRTSdat$TH_jack_marked
  TH_a_UM[,i] = GRTSdat$TH_adult_unmarked
  TH_j_UM[,i] = GRTSdat$TH_jack_unmarked
  #IMW redds
  temp2<-paste("sch",1:10,sep="")
  sch[,,i] = as.matrix(GRTSdat[colnames(GRTSdat)%in%temp2])
  rownames(sch)<-GRTSdat$GRTS_Population
  IMW_redd_tot[,i] = GRTSdat$IMW_redd_tot
  IMW_miles[,i] = GRTSdat$IMW_miles
  #Create indices for survey schedule counts
  good_sch_index[,i] = apply(sch[,,i],1,function(x) length(which(!is.na(x))))
  if(sum(good_sch_index[,i]>0)){sch_years<-c(sch_years,i)}
  for(j in 1:dim(sch)[1]){
    good_sch[j,,i]=round(col(sch[,,i])[1,]*((sch[j,,i]+1)/(sch[j,,i]+1)))
    good_sch[j,,i]<-good_sch[j,,i][order(good_sch[j,,i])]
  }
  
}
pops_sites_index<-apply(pops_sites,2,function(x) length(which(!is.na(x))))
pops_sites_index2<-apply(pops_sites2,2,function(x) length(which(!is.na(x))))
unk_p_index_index<-apply(unk_p_index,2,function(x) length(which(!is.na(x))))
good_MR_data_index<-apply(good_MR_data,2,function(x) length(which(!is.na(x))))
no_MR_data_index<-apply(no_MR_data,2,function(x) length(which(!is.na(x))))
IMW_redd_tot[!GRTSdat$GRTS_Population%in%c("Abernathy","Mill","Germany")]<-0
IMW_redd_tot[GRTSdat$Order[GRTSdat$GRTS_Population%in%c("Mill","Germany")],!c(1:yrs)%in%sch_years]<-0
catch_pops=GRTSdat$Order[GRTSdat$GRTS_Population%in%c("Upper Cowlitz and Cispus","Tilton","Upper NF Toutle","Upper NF Lewis")] #no catch in upper NF Toutle or Lewis
names(catch_pops)<-c("Upper Cowlitz and Cispus","Tilton","Upper NF Toutle","Upper NF Lewis")


#==================
#data list for JAGS
#==================
jagsdat<-list(
  #=========
  #GRTS DATA
  #=========
  yrs=yrs,
  pops=pops, #Number of pops from GRTS
  sites=sites, # number of GRTS sites per pop
  pops_sites=pops_sites,#list of pops with >0 GRTS sites by year
  pops_sites2=pops_sites2, #number of pops with >0 GRTS sites by year
  pops_sites_index=pops_sites_index,#list of pops with >0 index miles by year
  pops_sites_index2=pops_sites_index2, #number of pops with >0 Index Miles by year
  p_index=p_index,#proportion of abundance accounted for by index counts (only known where indexes are census or GRTS are census)
  unk_p_index=unk_p_index,#list of pops unknown in GRTS and Index counts 
  unk_p_index_index=unk_p_index_index,#number of pops unknown in GRTS and Index counts 
  Y2=Y2+NON_TWS_redds+IMW_redd_tot, #index redds
  Y=Y,#redds in GRTS reaches
  redd_min=Y+Y2+IMW_redd_tot+NON_TWS_redds,#+IMW_redd_tot_inits ADDED LATER TO FIRST GET RID OF ZEROS
  mis_miles=mis_miles, #miles in GRTS frame minus GRTS survey # mileage, minus index, minus truncations for barriers.
  F_miles=F_miles,
  GRTS_miles=GRTS_miles,
  I_miles=I_miles,
  F=Fm,#female carcs sampled
  AS=AS,#adult carcs sampled no jacks
  H=H,#hatchery fish (define type!)
  MS=MS,#mark samples
  UM_ad_lim=MS-H,
  Oc=Oc,#number of reaches in a basin w/ greater than zero count
  y=y,# new redd count by reach for whole season in each basin; order is GRTS pops #order, need same #  of reaches for all, fill in with NA; Dimensions of raw redds/reach mile data (Rows, Columns)
  g=g,# GRTS reach
  #log_mu_c_obs=log(pmax((Y+Y2+NON_TWS_redds+IMW_redd_tot)/pmax(F_miles-mis_miles,0.001),0.001)),
  #log_mu2_obs=log(missed_redds_obs)/(mis_miles+0.001)+0.001,
  #====================================
  #RpF Data (which is merged with GRTS)
  #====================================
  n1=n1,
  n2=n2,
  m=m,
  good_MR_data=good_MR_data,
  good_MR_data_index=good_MR_data_index,
  Nb_lim=Nb_lim,
  no_MR_data=no_MR_data,
  no_MR_data_index=no_MR_data_index,
  #===============
  #Weirs/MR
  #==============
  IMWpops=GRTSdat$Order[GRTSdat$GRTS_Population%in%c("Abernathy","Mill","Germany")],
  IMW_miles=IMW_miles,
  sch = sch,
  IMW_redd_lim = sch,
  good_sch_index = good_sch_index,
  good_sch = good_sch,
  sch_years=sch_years,
  #===================
  #Trap and Haul
  #==================
  catch_pops=catch_pops,
  log_catch_a_M_mu = log_catch_a_M_mu,
  catch_a_M_SD =  catch_a_M_SD+.05,
  log_catch_j_M_mu = log_catch_j_M_mu,
  catch_j_M_SD = catch_j_M_SD+.05,
  TH_a_M = TH_a_M,
  TH_j_M = TH_j_M,
  TH_a_UM = TH_a_UM,
  TH_j_UM = TH_a_UM,
  #=============
  #model params
  #============
  xi=13.8155,#constrain logit
  beta_a_prior=0.5,
  beta_b_prior=0.5
)

#==============================================
#Deal with some issues with trap and haul data
#==============================================
#Give observation error for years catch estimates missing
jagsdat$catch_a_M_SD[is.na(jagsdat$catch_a_M_SD)]<-0.25
jagsdat$catch_j_M_SD[is.na(jagsdat$catch_j_M_SD)]<-0.25
#set trap and haul counts to zero for non T+H pops
jagsdat$TH_a_M[!GRTSdat$Order%in%jagsdat$catch_pops,]<-0
jagsdat$TH_a_UM[!GRTSdat$Order%in%jagsdat$catch_pops,]<-0
jagsdat$catch_a_M<-matrix(0,nrow=pops[1],ncol=length(years))
jagsdat$catch_a_M[GRTSdat$Order%in%jagsdat$catch_pops[names(catch_pops)%in%c("Upper Cowlitz and Cispus","Tilton")],]<-NA
jagsdat$H[GRTSdat$Order%in%jagsdat$catch_pops,]<-0
jagsdat$MS[GRTSdat$Order%in%jagsdat$catch_pops,]<-0
#jagsdat$F_miles[GRTSdat$Order%in%jagsdat$catch_pops,]<-0
jagsdat$non_TH_pops<-rep(1,pops[1])
jagsdat$non_TH_pops[catch_pops]<-0
jagsdat$TH_pops<-rep(1,pops[1])
jagsdat$TH_pops[catch_pops]<-2
jagsdat$TH_pops<-as.factor(jagsdat$TH_pops)
#==========================
#Give JAGS data index names
#==========================
namelist<-c("sites","Y2","Y","mis_miles","F","AS","H","MS","Oc","I_miles","GRTS_miles","p_index",
            "n1","n2","m","Nb_lim",
            "log_catch_a_M_mu","catch_a_M_SD","log_catch_j_M_mu","catch_j_M_SD",
            "TH_a_M","TH_j_M","TH_a_UM","TH_j_UM","IMW_miles","good_sch_index","redd_min"
)
for(n in 1:length(namelist)){
  colnames(jagsdat[names(jagsdat)%in%namelist][[n]])<-years
  rownames(jagsdat[names(jagsdat)%in%namelist][[n]])<-GRTSdat$GRTS_Population
}
dimnames(jagsdat$y)[[3]]<-years
dimnames(jagsdat$y)[[2]]<-temp
dimnames(jagsdat$g)[[3]]<-years
dimnames(jagsdat$g)[[2]]<-temp
dimnames(jagsdat$sch)[[3]]<-years
dimnames(jagsdat$sch)[[2]]<-temp2
rownames(jagsdat$good_sch)<-GRTSdat$GRTS_Population
#===================================================
#give Mill and Germany Abernathy's sex and mark data
#===================================================
MG<-c("Germany","Mill")
schtots<-matrix(NA,pops[1],yrs)
rownames(schtots)<-GRTSdat$GRTS_Population
for(y in 1:yrs){
  schtots[,y]<-rowSums(sch[,,y],na.rm=T)
}
for(i in 1:2){
  jagsdat$H[rownames(jagsdat$H)==MG[i],]<-jagsdat$H[rownames(jagsdat$H)%in%c("Abernathy"),]
  jagsdat$MS[rownames(jagsdat$MS)==MG[i],]<-jagsdat$MS[rownames(jagsdat$MS)%in%c("Abernathy"),]
  jagsdat$F[rownames(jagsdat$F)==MG[i],]<-jagsdat$F[rownames(jagsdat$F)%in%c("Abernathy"),]
  jagsdat$AS[rownames(jagsdat$AS)==MG[i],]<-jagsdat$AS[rownames(jagsdat$AS)%in%c("Abernathy"),]
}
#means for starting states
mu_est<-matrix(NA,pops,yrs)
rownames(mu_est)<-GRTSpops$GRTS_Population
for(i in 1:pops[1]){
  for(j in 1:yrs){
    if(jagsdat$GRTS_miles[i,j]>0 & jagsdat$I_miles[i,j]>0){
      mu_est[i,j]<-(jagsdat$Y[i,j]/jagsdat$GRTS_miles[i,j])*((jagsdat$GRTS_miles[i,j]+jagsdat$mis_miles[i,j])/jagsdat$F_miles[i,j]) +
        (jagsdat$Y2[i,j]/jagsdat$I_miles[i,j])*(jagsdat$I_miles[i,j]/jagsdat$F_miles[i,j])
    }
    if(jagsdat$GRTS_miles[i,j]>0 & jagsdat$I_miles[i,j]==0){
      mu_est[i,j]<-(jagsdat$Y[i,j]/jagsdat$GRTS_miles[i,j])
    }
    if(jagsdat$GRTS_miles[i,j]==0 & jagsdat$I_miles[i,j]>0){
      mu_est[i,j]<-(jagsdat$Y2[i,j]/jagsdat$I_miles[i,j])
    }
  }
}
jagsdat$mu_est1<-mu_est[,1]
jagsdat$mu_est1[is.na(jagsdat$mu_est1)]<-rowMeans(mu_est,na.rm=T)[is.na(jagsdat$mu_est1)]
jagsdat$mu_est1[names(jagsdat$mu_est1)%in%c("Germany","Mill")]<-jagsdat$mu_est1[names(jagsdat$mu_est1)=="Abernathy"]#abernathy given to mill, germany, and coal
jagsdat$mu_est1[is.na(jagsdat$mu_est1)]<-mean(jagsdat$mu_est1,na.rm = T)
jagsdat$lambda_est1<-jagsdat$mu_est1*jagsdat$F_miles[,1]/0.5/0.5 #convert redd density into adult estimate
#adjust median ()
jagsdat$lambda_est1[names(jagsdat$lambda_est1)%in%c("Upper Cowlitz and Cispus","Tilton","Upper NF Toutle","Upper NF Lewis")]<-c(3000,2500,200,0.01) #Upper Cowlitz/Cispus
#jagsdat$F_miles[catch_pops,]<-NA

jagsdat$pops_sites3<-data.frame(rbind(jagsdat$pops_sites2,jagsdat$pops_sites))
jagsdat$pops_sites3[apply(jagsdat$pops_sites3,2, duplicated)]<-NA
jagsdat$pops_sites3<-apply(jagsdat$pops_sites3,2,function(x) sort(x,na.last = T))
jagsdat$pops_sites_index3<-apply(jagsdat$pops_sites3,2,function(x) length(which(!is.na(x))))
jagsdat$zeros<-rep(0,jagsdat$pops[1])
#=============================================================================
#set F miles to 0 for Upper NF lewis before trap and haul (VERY IMPORTANT)
#=============================================================================
rownames(jagsdat$F_miles)<-GRTSpops$GRTS_Population
jagsdat$F_miles[row.names(jagsdat$F_miles)=="Upper NF Lewis",which(years%in%c(2010:2011))]<-1E-9
#================
#set cauchy prior
#================
jagsdat$cauchy_scale<-0.5


#Fix pHOS data for coal
jagsdat$H[rownames(jagsdat$H)=="Coal",colnames(jagsdat$H)<2018]<-jagsdat$H[rownames(jagsdat$H)%in%c("Abernathy"),colnames(jagsdat$H)<2018]
jagsdat$MS[rownames(jagsdat$MS)=="Coal",colnames(jagsdat$H)<2018]<-jagsdat$MS[rownames(jagsdat$MS)%in%c("Abernathy"),colnames(jagsdat$H)<2018]

```

# Reconfigure Data for New Stan Model
```{r Reconfigure Data for New Stan Model, message = FALSE, warning = FALSE,results = "hide"}
#pm
H<-jagsdat$H%>%
  as_tibble()%>%
  rownames_to_column(var = "pop_pm")%>%
  pivot_longer(cols = !c("pop_pm"),
               names_to = "yr_pm",
               values_to = "H"
               )
MS_H<-jagsdat$MS%>%
  as_tibble()%>%
  rownames_to_column(var = "pop_pm")%>%
  pivot_longer(cols = !c("pop_pm"),
               names_to = "yr_pm",
               values_to = "MS"
               )%>%
  left_join(H,by=c("yr_pm","pop_pm"))%>%
  filter(MS>0)%>%
  ungroup()%>%
  mutate(pop_pm=as.numeric(as.character(pop_pm)),
         yr_pm=as.numeric(as.character(yr_pm)),
         yr_pm = yr_pm-min(years)+1
         
         )
#pf
F<-jagsdat$F%>%
  as_tibble()%>%
  rownames_to_column(var = "pop_pf")%>%
  pivot_longer(cols = !c("pop_pf"),
               names_to = "yr_pf",
               values_to = "F"
               )
AS_F<-jagsdat$AS%>%
  as_tibble()%>%
  rownames_to_column(var = "pop_pf")%>%
  pivot_longer(cols = !c("pop_pf"),
               names_to = "yr_pf",
               values_to = "AS"
               )%>%
  left_join(F,by=c("yr_pf","pop_pf"))%>%
  filter(AS>0)%>%
  ungroup()%>%
  mutate(pop_pf=as.numeric(as.character(pop_pf)),
         yr_pf=as.numeric(as.character(yr_pf)),
         yr_pf = yr_pf-min(years)+1
         
         )
#mr
n2<-jagsdat$n2%>%
  as_tibble()%>%
  rownames_to_column(var = "pop_mr")%>%
  pivot_longer(cols = !c("pop_mr"),
               names_to = "yr_mr",
               values_to = "n2"
               )
m<-jagsdat$m%>%
  as_tibble()%>%
  rownames_to_column(var = "pop_mr")%>%
  pivot_longer(cols = !c("pop_mr"),
               names_to = "yr_mr",
               values_to = "m"
               )
n1_n2_m<-jagsdat$n1%>%
  as_tibble()%>%
  rownames_to_column(var = "pop_mr")%>%
  pivot_longer(cols = !c("pop_mr"),
               names_to = "yr_mr",
               values_to = "n1"
               )%>%
  left_join(n2,by=c("yr_mr","pop_mr"))%>%
  left_join(m,by=c("yr_mr","pop_mr"))%>%
  filter(n1>0)%>%
  ungroup()%>%
  mutate(pop_mr=as.numeric(as.character(pop_mr)),
         yr_mr=as.numeric(as.character(yr_mr)),
         yr_mr = yr_mr-min(years)+1
         
         )
#Y2-Index redds
I_miles<-jagsdat$I_miles%>%
  as_tibble()%>%
  rownames_to_column(var = "pop_Y2")%>%
  pivot_longer(cols = !c("pop_Y2"),
               names_to = "yr_Y2",
               values_to = "I_miles"
               )
IMW_Y2<-read_csv(file.path(csv.data.dir,IMWdata_v2.name))%>%
  left_join(GRTSpops%>%
              dplyr::select(GRTS_Population,Order)%>%
              mutate(Order = as.character(Order))
              , by = c("GRTS_Population")
            )%>%filter(GRTS_Population != "Abernathy" & I_miles > 0)%>%
    dplyr::rename(yr_Y2 = Year, pop_Y2 = Order)%>%
    mutate(yr_Y2 = as.character(yr_Y2))%>%
    dplyr::select(!c(Comment))
Y2<-jagsdat$Y2%>%
  as_tibble()%>%
  rownames_to_column(var = "pop_Y2")%>%
  pivot_longer(cols = !c("pop_Y2"),
               names_to = "yr_Y2",
               values_to = "Y2"
               )%>%
  left_join(GRTSpops%>%
              dplyr::select(GRTS_Population,Order)%>%
              mutate(Order = as.character(Order))
              , by = c("pop_Y2"="Order")
  )%>%
  left_join(I_miles,by=c("yr_Y2","pop_Y2"))%>%
  filter(I_miles>0 & !is.na(Y2))%>%
  bind_rows(IMW_Y2)%>%
  ungroup()%>%
  mutate(pop_Y2=as.numeric(as.character(pop_Y2)),
         yr_Y2=as.numeric(as.character(yr_Y2)),
         yr_Y2 = yr_Y2-min(years)+1)
  
#Y GRTS redds
g<-melt(jagsdat$g)%>%
  as_tibble()%>%
  dplyr::rename(pop_Y = X1, Reach = X2, yr_Y = X3, g = value)

Y<-melt(jagsdat$y)%>%
  as_tibble()%>%
  dplyr::rename(pop_Y = X1, Reach = X2, yr_Y = X3, Y = value)%>%
  left_join(g, by=c("yr_Y","pop_Y","Reach"))%>%
  left_join(GRTSpops%>%
            dplyr::select(GRTS_Population,Order)%>%
            mutate(Order = as.character(Order))
            , by = c("pop_Y"="GRTS_Population")
  )%>%
  dplyr::rename(GRTS_Population=pop_Y,pop_Y=Order)%>%
  #adding some filters in that shouldn't have to exist
  filter(!is.na(g))%>%
  filter(!is.na(Y))%>%
  ungroup()%>%
  mutate(pop_Y=as.numeric(as.character(pop_Y)),
         yr_Y=as.numeric(as.character(yr_Y)),
         yr_Y = yr_Y-min(years)+1)

#indexes for P_Index
yr_pop<-expand_grid(yr_Y2=years,pop_Y2=c(1:jagsdat$pops[1]))%>%
  mutate(yr_Y2 = as.character(yr_Y2), pop_Y2 = as.character(pop_Y2))%>%
  mutate(pop_Y2=as.numeric(as.character(pop_Y2)),
         yr_Y2=as.numeric(as.character(yr_Y2)),
         yr_Y2 = yr_Y2-min(years)+1
  )

I_miles_mat = Y2%>%
  dplyr::select(yr_Y2,pop_Y2,I_miles)%>%
  right_join(yr_pop,by=c("yr_Y2","pop_Y2"))%>%
  mutate(I_miles = replace_na(I_miles,0))%>%
  mutate(pop_Y2 = as.numeric(pop_Y2))%>%
  arrange(pop_Y2,yr_Y2)%>%
  pivot_wider(names_from = yr_Y2,values_from = I_miles)%>%
  dplyr::select(!pop_Y2)
  

index_data_only<-I_miles_mat 
index_data_only[jagsdat$GRTS_miles==0 & index_data_only > 0 ]<-1
index_data_only[jagsdat$GRTS_miles!=0]<-0
index_data_only<-t(index_data_only)

index_and_GRTS<-I_miles_mat
index_and_GRTS[jagsdat$GRTS_miles == 0]<-0
index_and_GRTS[index_and_GRTS>0]<-1
index_and_GRTS<-index_and_GRTS%>%
  as_tibble()%>%
  rownames_to_column(var = "pop_grts_and_index")%>%
  pivot_longer(cols = !c("pop_grts_and_index"),
               names_to = "yr_grts_and_index",
               values_to = "index_and_GRTS"
               )%>%
  filter(index_and_GRTS==1)%>%
  ungroup()%>%
  mutate(pop_grts_and_index=as.numeric(as.character(pop_grts_and_index)),
         yr_grts_and_index=as.numeric(as.character(yr_grts_and_index)),
         )
#Trap and Haul and CRC data
catch_a_M_SD_dat<-jagsdat$catch_a_M_SD%>%
  as_tibble()%>%
  rownames_to_column(var = "crc_pops")%>%
  pivot_longer(cols = !c("crc_pops"),
               names_to = "crc_years_real",
               values_to = "catch_a_M_SD"
               )
catch_a_M_mu_dat<-jagsdat$log_catch_a_M_mu%>%
  as_tibble()%>%
  rownames_to_column(var = "crc_pops")%>%
  pivot_longer(cols = !c("crc_pops"),
               names_to = "crc_years_real",
               values_to = "log_catch_a_M_mu"
               )%>%
  mutate(catch_a_M_mu = exp(log_catch_a_M_mu))%>%
  filter(!is.na(catch_a_M_mu) & catch_a_M_mu > 0)%>%
  left_join(catch_a_M_SD_dat, by = c("crc_pops","crc_years_real"))%>%
  left_join(years%>%
              as_tibble()%>%
              rownames_to_column()%>%
              dplyr::rename(crc_years=rowname,crc_years_real=value)%>%
              mutate(crc_years_real=as.character(crc_years_real)),
            
            by = c("crc_years_real")
  )

catch_a_M_mu<-catch_a_M_mu_dat%>%
  dplyr::select(crc_pops,crc_years,catch_a_M_mu)%>%
  mutate(crc_pops=as.numeric(as.character(crc_pops)),
         crc_years=as.numeric(as.character(crc_years))
  )%>%
  pivot_wider(names_from = crc_pops,values_from = catch_a_M_mu)%>%
  ungroup()

catch_a_M_SD<-catch_a_M_mu_dat%>%
  dplyr::select(crc_pops,crc_years,catch_a_M_SD)%>%
  mutate(crc_pops=as.numeric(as.character(crc_pops)),
         crc_years=as.numeric(as.character(crc_years))
  )%>%
  pivot_wider(names_from = crc_pops,values_from = catch_a_M_SD)%>%
  ungroup()



#===================
#make stan data list
#===================

#may need to fix del and ost mileage!
standat<-list(
  T = jagsdat$yrs,
  P = jagsdat$pops[1],
  F_miles = t(jagsdat$F_miles),
  GRTS_miles = t(jagsdat$GRTS_miles),
  missed_miles = apply(t(jagsdat$mis_miles),1:2,function(x) max(0,x)),#check to verify that GRTS + Index + Miss = Fmiles FIX becaus added IMW miles to index!!!
  #pM
  n_pm = nrow(MS_H), #number of pMark Likelihoods
  H = MS_H$H, #Hatchery adults
  MS = MS_H$MS, #Mark-Sample adults
  pop_pm = MS_H$pop_pm, #pop index
  yr_pm = MS_H$yr_pm, #yr index
  #pF
  n_pf = nrow(AS_F), #number of pFemale Likelihoods
  F = AS_F$F, #Hatchery adults
  AS = AS_F$AS, #Adult Sample
  pop_pf = AS_F$pop_pf, #pop index
  yr_pf = AS_F$yr_pf,#yr index
  #mr
  n_mr = nrow(n1_n2_m), #number of mark-recap Likelihoods
  n1 = n1_n2_m$n1, #marks
  n2 = n1_n2_m$n2, #captures
  m = n1_n2_m$m, #recaptures
  pop_mr = n1_n2_m$pop_mr, #pop index
  yr_mr = n1_n2_m$yr_mr, #yr index
  #index redds
  n_Y2 = nrow(Y2),#number of index redd Likelihoods
  Y2 = Y2$Y2, #index redd count
  pop_Y2 = Y2$pop_Y2, #pop index
  yr_Y2 = Y2$yr_Y2,#yr index
  #grts redds
  n_Y = nrow(Y), #number of grts redd Likelihoods
  Y = Y$Y, #GRTS redd count
  g = Y$g, #GRTS reach length
  pop_Y = Y$pop_Y, #pop index
  yr_Y = Y$yr_Y, #yr index
  #indexes to identify when >0 GRTS and >0 Index reaches
  index_data_only = index_data_only,
  n_grts_and_index = dim(index_and_GRTS)[1],
  yr_grts_and_index = index_and_GRTS$yr_grts_and_index,
  pop_grts_and_index = index_and_GRTS$pop_grts_and_index,
  #Trap and Haul Data
  n_TH_pops = length(jagsdat$catch_pops),# number of pops with any Trap and Haul data
  TH_pops= jagsdat$catch_pops, #pop indexes for TH pops
  TH_a_UM = t(jagsdat$TH_a_UM[jagsdat$catch_pops,]), #Unmarked Adults Traped and Haul (Year by pop matrix)
  TH_a_M = t(jagsdat$TH_a_M[jagsdat$catch_pops,]), #Marked Adults Traped and Haul (Year by pop matrix)
  n_crc_years = nrow(catch_a_M_mu),
  n_crc_pops = ncol(catch_a_M_mu%>%dplyr::select(!crc_years)), #number of pops with CRC data
  crc_pops = as.numeric(unique(catch_a_M_mu_dat$crc_pops)), #years CRC data available
  crc_years = catch_a_M_mu$crc_years, #years CRC data available for
  catch_a_M_mu = catch_a_M_mu%>%dplyr::select(!crc_years), #CRC catch MLE
  catch_a_M_SD = catch_a_M_SD%>%dplyr::select(!crc_years),  #CRC catch SD converted to lognormal SD using moment matching
  #priors
  cauchy_scale = 0.5
)


#==============
# Data checks
#=============

#in years with index only data (where pindex =1, do we have an index miles?)
problems <- jagsdat$mis_miles %>%
  t() %>%
  reshape::melt() %>%
  bind_cols(standat$index_data_only %>%
              reshape::melt()
            ) %>%
  setNames(c("Year", "GRTS_Population", "Missed_miles", "GRTS_order", "Year_num", "index_data_only")) %>%
  filter(Missed_miles > 0 & index_data_only == 1)

#============
#manual Fixes to problems
#============
if(assume_Coal_Duncan_census==T){
  #set duncan and coal cr missed to 0
  standat$missed_miles[as.numeric(rownames(standat$missed_miles))>2017,colnames(standat$missed_miles)=="Coal"]<-0
    standat$missed_miles[as.numeric(rownames(standat$missed_miles))<2018,colnames(standat$missed_miles)=="Coal"]<-3.86
  standat$missed_miles[,colnames(standat$missed_miles)=="Duncan_Above Weir"]<-0  
}

saveRDS(standat,file.path(csv.data.dir,paste0("standata_",GRTSdat.date,".rds")))
```

#Fit Stan Model
```{r fit Stan model} 
standat<-readRDS(file.path(csv.data.dir,paste0("standata_",GRTSdat.date,".rds")))
#======================
#create final data folder
#=====================
if(fit_Stan == TRUE){
  subDir<-paste("Results","_",Sys.Date(),sep="")
  if (!file.exists(file.path(results.dir, subDir))){
    dir.create(file.path(results.dir, subDir))
  }
  #=============
  #compile model
  #=============
  if(!file.exists(file.path(models.dir,gsub(".stan",".rds",stan_model.file)))){
    model<-stan_model(file = file.path(models.dir,stan_model.file))
    saveRDS(model,file.path(models.dir,gsub(".stan",".rds",stan_model.file)))
  }else{
    model<-readRDS(file.path(models.dir,gsub(".stan",".rds",stan_model.file)))
  }
  #===========
  # Fit Model
  #===========
  print(paste0("Start Time = ",Sys.time()))
  stanfit<-sampling(object=model
                    ,data=standat
                    ,cores=chains
                    ,chains = chains
                    ,iter = iter
                    ,warmup= burn
                    ,thin = thin
                    ,control=control
                    ,init="0"
                    #,verbose=F
                    #,open_progress=F
                    #,show_messages=F
                    #,algorithm ="NUTS"
        )
  saveRDS(stanfit,file.path(results.dir,subDir,"stanfit.RDS"))
  summary<-summary(stanfit)$summary
  write.csv(summary,file.path(results.dir,subDir,"Stan_summary.csv"))
  res<-rstan::extract(stanfit)
}else{
  subDir<-results_name
  stanfit<-readRDS(file.path(results.dir,subDir,"stanfit.RDS"))
  res<-rstan::extract(stanfit)
}
```


# Posterior Predictive Checks
```{r}

H_PPC<-as.data.frame(apply(rstan::extract(stanfit)$H_rep,2, function(x) quantile(x, c(0.025,0.975))))%>%
  rownames_to_column(var="Quantile")%>%
  as_tibble()%>%
  pivot_longer(names_to = "names",values_to = "H",cols = c(-Quantile))%>%
  pivot_wider(names_from = Quantile,values_from = H)%>%
  bind_cols(tibble(H=standat$H,
                   subpopulation=standat$pop_pm,
                   year = standat$yr_pm,
                   )
  )%>%
  mutate(subpopulation = as.factor(subpopulation),
         year = as.factor(year),
         fit = factor(ifelse(H>=`2.5%` & H<=`97.5%`,"fit","no fit"))
         )

H_PPC %>%
  group_by(subpopulation,year) %>%
  summarise(
    fit_count = sum(fit == "fit"),
    no_fit_count = sum(fit == "no fit"),
    total_count = fit_count + no_fit_count,
    bayes_p = ifelse(no_fit_count == 0, 1, fit_count / total_count)
  ) %>%
  dplyr::select(subpopulation,year, bayes_p)%>%
  pivot_wider(names_from = year,values_from = bayes_p)%>%
  ungroup()%>%
  kbl()%>%
  kable_classic(html_font = "Times New Roman")

H_PPC_plt<-ggplot(H_PPC, aes(x = H, y = H, color=subpopulation,group=year)) +
  geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0) +
  labs(x = substitute(italic(s)[H], list(H = "H")), y = "95% PPI") +
  geom_line(color="black") +
  ylim(0, max(H_PPC$`97.5%`)) +
  xlim(0, max(H_PPC$`97.5%`)) +
  theme(text = element_text(size = 12))

ggsave(filename=here::here(file.path("results",results_name,"H_PPC.png")),
       plot = H_PPC_plt,
       width = 6.5, height = 6.5, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
       )

F_PPC<-as.data.frame(apply(rstan::extract(stanfit)$F_rep,2, function(x) quantile(x, c(0.025,0.975))))%>%
  rownames_to_column(var="Quantile")%>%
  as_tibble()%>%
  pivot_longer(names_to = "names",values_to = "F",cols = c(-Quantile))%>%
  pivot_wider(names_from = Quantile,values_from = F)%>%
  bind_cols(tibble(F=standat$F,
                   subpopulation=standat$pop_pf,
                   year = standat$yr_pf,
                   )
  )%>%
  mutate(subpopulation = as.factor(subpopulation),
         year = as.factor(year),
         fit = factor(ifelse(F>=`2.5%` & F<=`97.5%`,"fit","no fit"))
         )

F_PPC %>%
  group_by(subpopulation,year) %>%
  summarise(
    fit_count = sum(fit == "fit"),
    no_fit_count = sum(fit == "no fit"),
    total_count = fit_count + no_fit_count,
    bayes_p = ifelse(no_fit_count == 0, 1, fit_count / total_count)
  ) %>%
  pivot_wider(names_from = year,values_from = bayes_p)%>%
  ungroup()%>%
  kbl()%>%
  kable_classic(html_font = "Times New Roman")



p<-ggplot(F_PPC, aes(x = F, y = F, color=subpopulation,group=year)) +
  geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0) +
  labs(x = substitute(italic(s)[F], list(F = "F")), y = "95% PPI") +
  geom_line(color="black") +
  ylim(0, max(F_PPC$`97.5%`)) +
  xlim(0, max(F_PPC$`97.5%`))+
  theme(text = element_text(size = 12))

ggsave(filename=here::here(file.path("results",results_name,"F_PPC.png")),
       plot = p,
       width = 6.5, height = 6.5, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
       )


n1_PPC<-as.data.frame(apply(rstan::extract(stanfit)$n1_rep,2, function(x) quantile(x, c(0.025,0.975))))%>%
  rownames_to_column(var="Quantile")%>%
  as_tibble()%>%
  pivot_longer(names_to = "names",values_to = "n1",cols = c(-Quantile))%>%
  pivot_wider(names_from = Quantile,values_from = n1)%>%
  bind_cols(tibble(n1=standat$n1,
                   subpopulation=standat$pop_mr,
                   year = standat$yr_mr,
                   )
  )%>%
  mutate(subpopulation = as.factor(subpopulation),
         year = as.factor(year),
         fit = factor(ifelse(n1>=`2.5%` & n1<=`97.5%`,"fit","no fit"))
         )

n1_PPC %>%
  group_by(subpopulation,year) %>%
  summarise(
    fit_count = sum(fit == "fit"),
    no_fit_count = sum(fit == "no fit"),
    total_count = fit_count + no_fit_count,
    bayes_p = ifelse(no_fit_count == 0, 1, fit_count / total_count)
  ) %>%
  ungroup()


p<-ggplot(n1_PPC, aes(x = n1, y = n1, color=subpopulation,group=year)) +
  geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0) +
  labs(x = substitute(italic(n1)), y = "95% PPI") +
  geom_line(color="black") +
  ylim(0, max(n1_PPC$`97.5%`)) +
  xlim(0, max(n1_PPC$`97.5%`))+
  theme(text = element_text(size = 12))

ggsave(filename=here::here(file.path("results",results_name,"n1_PPC.png")),
       plot = p,
       width = 6.5, height = 6.5, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
       )

m_PPC<-as.data.frame(apply(rstan::extract(stanfit)$m_rep,2, function(x) quantile(x, c(0.025,0.975))))%>%
  rownames_to_column(var="Quantile")%>%
  as_tibble()%>%
  pivot_longer(names_to = "names",values_to = "m",cols = c(-Quantile))%>%
  pivot_wider(names_from = Quantile,values_from = m)%>%
  bind_cols(tibble(m=standat$m,
                   subpopulation=standat$pop_mr,
                   year = standat$yr_mr,
                   )
  )%>%
  mutate(subpopulation = as.factor(subpopulation),
         year = as.factor(year),
         fit = factor(ifelse(m>=`2.5%` & m<=`97.5%`,"fit","no fit"))
         )

m_PPC %>%
  group_by(subpopulation,year) %>%
  summarise(
    fit_count = sum(fit == "fit"),
    no_fit_count = sum(fit == "no fit"),
    total_count = fit_count + no_fit_count,
    bayes_p = ifelse(no_fit_count == 0, 1, fit_count / total_count)
  ) %>%
  ungroup()


p<-ggplot(m_PPC, aes(x = m, y = m, color=subpopulation,group=year)) +
  geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0) +
  labs(x =substitute(italic(m)), y = "95% PPI") +
  geom_line(color="black") +
  ylim(0, max(m_PPC$`97.5%`)) +
  xlim(0, max(m_PPC$`97.5%`))+
  theme(text = element_text(size = 12))

ggsave(filename=here::here(file.path("results",results_name,"m_PPC.png")),
       plot = p,
       width = 6.5, height = 6.5, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
       )

Y2_PPC<-as.data.frame(apply(rstan::extract(stanfit)$Y2_rep,2, function(x) quantile(x, c(0.025,0.975))))%>%
  rownames_to_column(var="Quantile")%>%
  as_tibble()%>%
  pivot_longer(names_to = "names",values_to = "Y2",cols = c(-Quantile))%>%
  pivot_wider(names_from = Quantile,values_from = Y2)%>%
  bind_cols(tibble(Y2=standat$Y2,
                   subpopulation=standat$pop_Y2,
                   year = standat$yr_Y2,
                   )
  )%>%
  mutate(subpopulation = as.factor(subpopulation),
         year = as.factor(year),
         fit = factor(ifelse(Y2>=`2.5%` & Y2<=`97.5%`,"fit","no fit"))
         )

Y2_PPC %>%
  group_by(subpopulation,year) %>%
  summarise(
    fit_count = sum(fit == "fit"),
    no_fit_count = sum(fit == "no fit"),
    total_count = fit_count + no_fit_count,
    bayes_p = ifelse(no_fit_count == 0, 1, fit_count / total_count)
  ) %>%
  ungroup()


p<-ggplot(Y2_PPC, aes(x = Y2, y = Y2, color=subpopulation,group=year)) +
  geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0) +
  labs(x = substitute(italic(r)[I], list(I = "I")), y = "95% PPI") +
  geom_line(color="black") +
  ylim(0, max(Y2_PPC$`97.5%`)) +
  xlim(0, max(Y2_PPC$`97.5%`))+
  theme(text = element_text(size = 12))

ggsave(filename=here::here(file.path("results",results_name,"Y2_PPC.png")),
       plot = p,
       width = 6.5, height = 6.5, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
       )


Y_PPC<-as.data.frame(apply(rstan::extract(stanfit)$Y_rep,2, function(x) quantile(x,c(0.025,0.975))))%>%
  rownames_to_column(var="Quantile")%>%
  as_tibble()%>%
  pivot_longer(names_to = "names",values_to = "Y",cols = c(-Quantile))%>%
  pivot_wider(names_from = Quantile,values_from = Y)%>%
  bind_cols(tibble(Y=standat$Y,
                   subpopulation=standat$pop_Y,
                   year = standat$yr_Y,
                   )
  )%>%
  mutate(subpopulation = as.factor(subpopulation),
         year = as.factor(year),
         fit = factor(ifelse(Y>=`2.5%` & Y<=`97.5%`,"fit","no fit"))
         )

Y_PPC %>%
  group_by(subpopulation,year) %>%
  summarise(
    fit_count = sum(fit == "fit"),
    no_fit_count = sum(fit == "no fit"),
    total_count = fit_count + no_fit_count,
    bayes_p = ifelse(no_fit_count == 0, 1, fit_count / total_count)
  ) %>%
  ungroup()


p <- ggplot(Y_PPC, aes(x = Y, y = Y, color=subpopulation,group=year)) +
  facet_grid(rows=vars(subpopulation), cols=vars(year), scales = "free") +
  geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0) +
  labs(x = substitute(italic(r)), y = "95% PPI") +
  geom_line(color="black") +
  theme(#strip.text = element_blank(),  # Remove facet labels
        #strip.background = element_blank(),  # Remove facet background
        legend.position = "none") +
  theme(text = element_text(size = 12))


ggsave(filename=here::here(file.path("results",results_name,"Y_PPC.png")),
       plot = p,
       width = 6.5, height = 6.5, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
       )

p9 <- ggplot(Y_PPC, aes(x = Y + 1, y = Y + 1, color = fit)) +
  geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0, position = position_jitter(width = 0.1, height = 0)) +
  labs(x = substitute(italic(r)), y = "95% PPI") +
  geom_line(color = "black") +
  scale_x_log10() +
  scale_y_log10() +
  theme(text = element_text(size = 12))

  


ggsave(filename=here::here(file.path("results",results_name,"Y_PPC_v2.png")),
       plot = p9,
       width = 6.5, height = 6.5, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
       )


TH_a_UM_PPC<-array(apply(rstan::extract(stanfit)$TH_a_UM_rep,2:3, function(x) quantile(x, c(0.025,0.975))), dim=c(2,nrow(standat$TH_a_UM),ncol(standat$TH_a_UM)))
dimnames(TH_a_UM_PPC)[[3]] = colnames(standat$TH_a_UM)
dimnames(TH_a_UM_PPC)[[2]] = rownames(standat$TH_a_UM)
dimnames(TH_a_UM_PPC)[[1]] = c("2.5%","97.5%")

TH_a_UM_PPC<-TH_a_UM_PPC%>%
  reshape2::melt()%>%
  as_tibble()%>%
  set_names(c("Quantile","year","subpopulation","TH_a_UM"))%>%
  pivot_wider(names_from = Quantile,values_from = TH_a_UM)%>%
  mutate(year=factor(year))%>%
  left_join(tibble(as.data.frame(standat$TH_a_UM)%>%
                     rownames_to_column(var="year")%>%
                     pivot_longer(cols=-year,values_to = "TH_a_UM",names_to = "subpopulation")
                   ),
            by=join_by(year,subpopulation)
  )%>%
  mutate(subpopulation = as.factor(subpopulation),
         year = as.factor(year),
         fit = factor(ifelse(TH_a_UM>=`2.5%` & TH_a_UM<=`97.5%`,"fit","no fit"))
         )

TH_a_UM_PPC %>%
  group_by(subpopulation,year) %>%
  summarise(
    fit_count = sum(fit == "fit"),
    no_fit_count = sum(fit == "no fit"),
    total_count = fit_count + no_fit_count,
    bayes_p = ifelse(no_fit_count == 0, 1, fit_count / total_count)
  ) %>%
  ungroup()


p<-ggplot(TH_a_UM_PPC, aes(x = TH_a_UM, y = TH_a_UM, color=subpopulation,group=year)) +
  geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0) +
  labs(x =  substitute(italic(T)[W], list(W = "W")), y = "95% PPI") +
  geom_line(color="black") +
  ylim(0, max(TH_a_UM_PPC$`97.5%`)) +
  xlim(0, max(TH_a_UM_PPC$`97.5%`))+
  theme(text = element_text(size = 12))

ggsave(filename=here::here(file.path("results",results_name,"TH_a_UM_PPC.png")),
       plot = p,
       width = 6.5, height = 6.5, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
       )


TH_a_M_PPC<-array(apply(rstan::extract(stanfit)$TH_a_M_rep,2:3, function(x) quantile(x, c(0.025,0.975))), dim=c(2,nrow(standat$TH_a_M),ncol(standat$TH_a_M)))
dimnames(TH_a_M_PPC)[[3]] = colnames(standat$TH_a_M)
dimnames(TH_a_M_PPC)[[2]] = rownames(standat$TH_a_M)
dimnames(TH_a_M_PPC)[[1]] = c("2.5%","97.5%")

TH_a_M_PPC<-TH_a_M_PPC%>%
  reshape2::melt()%>%
  as_tibble()%>%
  set_names(c("Quantile","year","subpopulation","TH_a_M"))%>%
  pivot_wider(names_from = Quantile,values_from = TH_a_M)%>%
  mutate(year=factor(year))%>%
  left_join(tibble(as.data.frame(standat$TH_a_M)%>%
                     rownames_to_column(var="year")%>%
                     pivot_longer(cols=-year,values_to = "TH_a_M",names_to = "subpopulation")
                   ),
            by=join_by(year,subpopulation)
  )%>%
  mutate(subpopulation = as.factor(subpopulation),
         year = as.factor(year),
         fit = factor(ifelse(TH_a_M>=`2.5%` & TH_a_M<=`97.5%`,"fit","no fit"))
         )

TH_a_M_PPC %>%
  group_by(subpopulation,year) %>%
  summarise(
    fit_count = sum(fit == "fit"),
    no_fit_count = sum(fit == "no fit"),
    total_count = fit_count + no_fit_count,
    bayes_p = ifelse(no_fit_count == 0, 1, fit_count / total_count)
  ) %>%
  ungroup()


p<-ggplot(TH_a_M_PPC, aes(x = TH_a_M, y = TH_a_M, color=subpopulation,group=year)) +
  geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0) +
  labs(x =  substitute(italic(T)[H], list(H = "H")), y = "95% PPI") +
  geom_line(color="black") +
  ylim(0, max(TH_a_M_PPC$`97.5%`)) +
  xlim(0, max(TH_a_M_PPC$`97.5%`))+
  theme(text = element_text(size = 12))

ggsave(filename=here::here(file.path("results",results_name,"TH_a_M_PPC.png")),
       plot = p,
       width = 6.5, height = 6.5, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
       )


catch_a_M_mu_PPC<-array(apply(rstan::extract(stanfit)$catch_a_M_mu_rep,2:3, function(x) quantile(x, c(0.025,0.975))), dim=c(2,nrow(standat$catch_a_M_mu),ncol(standat$catch_a_M_mu)))
dimnames(catch_a_M_mu_PPC)[[3]] = colnames(standat$catch_a_M_mu)
dimnames(catch_a_M_mu_PPC)[[2]] = rownames(standat$catch_a_M_mu)
dimnames(catch_a_M_mu_PPC)[[1]] = c("2.5%","97.5%")

catch_a_M_mu_PPC<-catch_a_M_mu_PPC%>%
  reshape2::melt()%>%
  as_tibble()%>%
  set_names(c("Quantile","year","subpopulation","catch_a_M_mu"))%>%
  pivot_wider(names_from = Quantile,values_from = catch_a_M_mu)%>%
  mutate(year=factor(year),subpopulation=factor(subpopulation))%>%
  left_join(tibble(as.data.frame(standat$catch_a_M_mu)%>%
                     rownames_to_column(var="year")%>%
                     pivot_longer(cols=-year,values_to = "catch_a_M_mu",names_to = "subpopulation")
                   ),
            by=join_by(year,subpopulation)
  )%>%
  mutate(subpopulation = as.factor(subpopulation),
         year = as.factor(year),
         fit = factor(ifelse(catch_a_M_mu>=`2.5%` & catch_a_M_mu<=`97.5%`,"fit","no fit"))
         )

catch_a_M_mu_PPC %>%
  group_by(subpopulation,year) %>%
  summarise(
    fit_count = sum(fit == "fit"),
    no_fit_count = sum(fit == "no fit"),
    total_count = fit_count + no_fit_count,
    bayes_p = ifelse(no_fit_count == 0, 1, fit_count / total_count)
  ) %>%
  ungroup()


p<-ggplot(catch_a_M_mu_PPC, aes(x = catch_a_M_mu, y = catch_a_M_mu, color=subpopulation,group=year)) +
  geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0) +
  labs(x =  substitute(italic(c)), y = "95% PPI") +
  geom_line(color="black") +
  ylim(0, max(catch_a_M_mu_PPC$`97.5%`)) +
  xlim(0, max(catch_a_M_mu_PPC$`97.5%`))+
  theme(text = element_text(size = 12))

ggsave(filename=here::here(file.path("results",results_name,"catch_a_M_mu_PPC.png")),
       plot = p,
       width = 6.5, height = 6.5, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
       )



Y_PPC<-as.data.frame(apply(rstan::extract(stanfit)$Y_rep,2, mean))%>%
  as_tibble()%>%
  setNames("mean")%>%
  bind_cols(tibble(Y=standat$Y,
                   subpopulation=standat$pop_Y,
                   year = standat$yr_Y,
                   )
  )%>%
  mutate(subpopulation = as.factor(subpopulation),
         year = as.factor(year)
         )

p10 <- ggplot(Y_PPC, aes(x = Y + 1, y = Y+1)) +
  geom_point(aes(x = jitter(Y + 1), y = mean + 1)) +
  labs(x = expression(paste(italic(r), " + 1 (GRTS Redds)")), y = expression(paste(italic(r)," + 1 (posterior mean)"))) +
  geom_line(color = "black") +
  scale_x_log10() +
  scale_y_log10() +
  theme(text = element_text(size = 12))

ggsave(filename = here::here(file.path("results", results_name, "Y_PPC_v3.png")),
       plot = p10,
       width = 6.5, height = 6.5, dpi = 300, limitsize = TRUE,
       scale = 1.75,
       units = "in"
)

p11 <- ggplot(Y_PPC%>%
              group_by(year,subpopulation)%>%
              summarise(mean=mean(mean),
                        mean_Y = mean(Y)
                        )
              , aes(x = mean_Y + 1, y = mean_Y+1)) +
  geom_point(aes(x = jitter(mean_Y + 1), y = mean)) +
  labs(x = expression(paste(italic(r), " + 1 (GRTS Redds) mean by subpopulation and year")), y = expression(paste(italic(r)," + 1 (mean of posterior means by subpopulation and year)"))) +
  geom_line(color = "black") +
  scale_x_log10() +
  scale_y_log10() +
  theme(text = element_text(size = 12))


ggsave(filename = here::here(file.path("results", results_name, "Y_PPC_v4.png")),
       plot = p11,
       width = 6.5, height = 6.5, dpi = 300, limitsize = TRUE,
       scale = 1.75,
       units = "in"
)


ggsave(filename = here::here(file.path("results", results_name, "Y_PPC_v4.png")),
       plot = grid.arrange(p9,p10,p11,ncol=1),
       width = 3, height = 9,dpi = 300, limitsize = TRUE,
       scale = 1.75,
       units = "in"
)




```



# Summarize GRTS and TRT Results 
```{r }
#name columns by GRTSpop
GRTSpop_params<-c("Adults","M_ad","UM_ad","pF","pM")
for(i in 1:length(GRTSpop_params)){
  res[names(res)==GRTSpop_params[i]]<-lapply(res[names(res)==GRTSpop_params[i]], 
    function(x){
      x<-aperm(x,c(1,3,2))
      colnames(x)<-rownames(jagsdat$Y); x
    }
  )
}
#jagsfit$BUGSoutput$sims.list$Adults<-jagsfit$BUGSoutput$sims.list$M_ad+jagsfit$BUGSoutput$sims.list$UM_ad
#jagsfit$BUGSoutput$sims.list$pM<-jagsfit$BUGSoutput$sims.list$M_ad/(jagsfit$BUGSoutput$sims.list$M_ad+jagsfit$BUGSoutput$sims.list$UM_ad)
#=============================
#Print out results by GRTS pop
#=============================
for(i in 1:length(GRTSpop_params)){
  sims<-res[names(res)==GRTSpop_params[i]]
  for(j in 1:yrs){
    temp<-NULL
    temp<-apply(sims[[1]][,,j],2,function(x) quantile(x,c(0.025,0.5,0.975)))
    temp<-temp[,colnames(temp)!=""]
    means<-NULL
    means<-colMeans(sims[[1]][,,j])
    means<-means[names(means)!=""]
    sd<-NULL
    sd<-apply(sims[[1]][,,j],2,sd)
    sd<-sd[names(sd)!=""]
    temp<-data.frame(means,sd,t(temp))
    if(!names(sims)[1]%in%c("pM","pF","p_index","")){temp<-round(temp)}
    if(names(sims)[1]%in%c("pM","pF","p_index")){temp<-round(temp,3)}
    #=====================
    #combine years results
    #=====================
    temp$Population<-rownames(temp)
    temp$Year<-years[j]
    temp<-temp[,c(c(dim(temp)[2]-1),dim(temp)[2],1:c(dim(temp)[2]-2))]
    colnames(temp)<-c("Population","Year","Mean","sd","lower 95% CI", "Median","Upper 95%CI")
    if(j==1){temp2<-temp}else{temp2<-data.frame(rbind(temp2,temp))}
    colnames(temp2)<-c("Population","Year","Mean","sd","lower 95% CI", "Median","Upper 95%CI")
    #======================
    # Year specific Results
    #======================
    colnames(temp)<-c("Mean","sd","lower 95% CI", "Median","Upper 95%CI")
    # if (file.exists(subDir)){
    #   setwd(file.path(results.dir, subDir,years[j]))
    # } else {
    #   dir.create(file.path(results.dir, subDir,years[j]))
    #   setwd(file.path(results.dir, subDir,years[j]))
    # }
    # write.csv(temp,paste(years[j],"_Coho_TRT_",names(TRTresults)[i],".csv",sep=""),row.names = T)
    
  }
  GRTS_results_filename<-file.path(results.dir, subDir,paste0(years[1],"_",years[length(years)],"_Coho_GRTSpop_",names(sims)[1],".csv"))
  write.csv(temp2,GRTS_results_filename,row.names = FALSE)
}



#==========
#TRT params
#==========
TRTpop_params<-c("M_ad","UM_ad") #pM, Adult total
TRTpops<-data.frame(read_csv(paste(csv.data.dir,frame_file.name,sep="/")))$TRT_Population
TRTresults<-list(NULL)
for(i in 1:length(TRTpop_params)){
  temp<-NULL
  temp<-lapply(res[names(res)==TRTpop_params[i]], 
               function(x) {
                 colnames(x) <-TRTpops; x
               }
               )
  TRTresults[[i]]<-array(NA,dim=c(dim(sims[[1]])[1],length(unique(TRTpops)),standat$T))
  dimnames(TRTresults[[i]])[[3]]<-years
  names(TRTresults)[i]<-TRTpop_params[i]
  for (j in 1:yrs){
    TRTresults[[i]][,,j]<-t(rowsum(t(temp[[1]][,,j]), group = colnames(temp[[1]][,,j]), na.rm = T))
    dimnames(TRTresults[[i]])[[2]]<-unique(TRTpops[order(TRTpops)])
    
  }
}
TRTresults$Adults<-TRTresults$M_ad+TRTresults$UM_ad
TRTresults$pM<-TRTresults$M_ad/(TRTresults$M_ad+TRTresults$UM_ad)

for(i in 1:length(names(TRTresults))){
  for(j in 1:yrs){
    temp<-NULL
    temp<-apply(TRTresults[[i]][,,j],2,function(x) quantile(x,c(0.025,0.5,0.975)))
    temp<-temp[,!is.na(colnames(temp))]
    means<-NULL
    means<-colMeans(TRTresults[[i]][,,j])
    means<-means[!is.na(names(means))]
    sd<-NULL
    sd<-apply(TRTresults[[i]][,,j],2,sd)
    sd<-sd[!is.na(names(sd))]
    temp<-data.frame(means,sd,t(temp))
    if(!names(TRTresults)[i]%in%c("pM")){temp<-round(temp)}
    if(names(TRTresults)[i]%in%c("pM")){temp<-round(temp,3)}
    #=====================
    #combine years results
    #=====================
    temp$Population<-rownames(temp)
    temp$Year<-years[j]
    temp<-temp[,c(c(dim(temp)[2]-1),dim(temp)[2],1:c(dim(temp)[2]-2))]
    colnames(temp)<-c("Population","Year","Mean","sd","lower 95% CI", "Median","Upper 95%CI")
    if(j==1){temp2<-temp}else{temp2<-data.frame(rbind(temp2,temp))}
    colnames(temp2)<-c("Population","Year","Mean","sd","lower 95% CI", "Median","Upper 95%CI")
    #======================
    # Year specific Results
    #======================
    colnames(temp)<-c("Mean","sd","lower 95% CI", "Median","Upper 95%CI")
    # if (file.exists(subDir)){
    #   setwd(file.path(results.dir, subDir,years[j]))
    # } else {
    #   dir.create(file.path(results.dir, subDir,years[j]))
    #   setwd(file.path(results.dir, subDir,years[j]))
    # }
    # write.csv(temp,paste(years[j],"_Coho_TRT_",names(TRTresults)[i],".csv",sep=""),row.names = T)
    
  }
  TRT_results_filename<-file.path(results.dir, subDir,paste0(years[1],"_",years[length(years)],"_Coho_TRT_",names(TRTresults)[i],".csv"))
  write.csv(temp2,TRT_results_filename,row.names = FALSE)
}
```

## Summarize Cowlitz Specific Results
```{r}

# ===============
# Cowlitz Results
# ==============
yr=standat$T
CowlitzNames<-c("Lower Cowlitz",
                "Delameter_Above Weir",
                "Lacamas_Above Weir",
                "Olequa_Above Weir",
                "Ostrander_Above Weir"
)
Cowlitz_Results<-NULL
for(i in 1:yrs){
  LowerCowlitz_DIP_Adults<-apply(res$Adults[,colnames(res$Adults)%in%CowlitzNames,i],1,sum)
  #plot(density(LowerCowlitz_DIP_Adults))
  Cowlitz_Adults<-apply(data.frame(LowerCowlitz_DIP_Adults,res$Adults[,colnames(res$Adults)%in%CowlitzNames,i]),2,function(x) c(quantile(x,c(0.025,0.25,0.5,0.75,0.975)),mean(x),sd(x)))
  Cowlitz_Adults<-data.frame(t(Cowlitz_Adults),i+2009)
  Cowlitz_Adults$Population<-c("Lower Cowlitz DIP",CowlitzNames)
  colnames(Cowlitz_Adults)[6:8]<-c("mean","sd","year")
  Cowlitz_Results<-rbind(Cowlitz_Results,Cowlitz_Adults)
  rownames(Cowlitz_Results)<-NULL
}
write.csv(Cowlitz_Results,file.path(results.dir, subDir, paste0("Cowlitz_Adults_2010_",2009+yrs,"_",Sys.Date(),".csv")),row.names = FALSE)

Cowlitz_Results<-NULL
for(i in 1:yrs){
  LowerCowlitz_DIP_NOR_Adults<-apply(res$UM_ad[,colnames(res$Adults)%in%CowlitzNames,i],1,sum)
  #plot(density(LowerCowlitz_DIP_NOR_Adults))
  Cowlitz_NOR_Adults<-apply(data.frame(LowerCowlitz_DIP_NOR_Adults,res$UM_ad[,colnames(res$Adults)%in%CowlitzNames,i]),2,function(x)  c(quantile(x,c(0.025,0.25,0.5,0.75,0.975)),mean(x),sd(x)))
  Cowlitz_NOR_Adults<-data.frame(t(Cowlitz_NOR_Adults),i+2009)
  Cowlitz_NOR_Adults$Population<-c("Lower Cowlitz DIP",CowlitzNames)
  colnames(Cowlitz_NOR_Adults)[6:8]<-c("mean","sd","year")
  Cowlitz_Results<-rbind(Cowlitz_Results,Cowlitz_NOR_Adults)
  rownames(Cowlitz_Results)<-NULL
}
write.csv(Cowlitz_Results,file.path(results.dir, subDir, paste0("Cowlitz_NOR_Adults_2010_",2009+yrs,"_",Sys.Date(),".csv")),row.names = FALSE)

Cowlitz_Results<-NULL
for(i in 1:yrs){
  LowerCowlitz_DIP_HOR_Adults<-apply(res$M_ad[,colnames(res$Adults)%in%CowlitzNames,i],1,sum)
  #plot(density(LowerCowlitz_DIP_NOR_Adults))
  Cowlitz_HOR_Adults<-apply(data.frame(LowerCowlitz_DIP_HOR_Adults,res$M_ad[,colnames(res$Adults)%in%CowlitzNames,i]),2,function(x)  c(quantile(x,c(0.025,0.25,0.5,0.75,0.975)),mean(x),sd(x)))
  Cowlitz_HOR_Adults<-data.frame(t(Cowlitz_HOR_Adults),i+2009)
  Cowlitz_HOR_Adults$Population<-c("Lower Cowlitz DIP",CowlitzNames)
  colnames(Cowlitz_HOR_Adults)[6:8]<-c("mean","sd","year")
  Cowlitz_Results<-rbind(Cowlitz_Results,Cowlitz_HOR_Adults)
  rownames(Cowlitz_Results)<-NULL
}
write.csv(Cowlitz_Results,file.path(results.dir, subDir, paste0("Cowlitz_HOR_Adults_2010_",2009+yrs,"_",Sys.Date(),".csv")),row.names = FALSE)

Cowlitz_Results<-NULL
for(i in 1:yrs){
  pM<-data.frame(res$M_ad[,colnames(res$Adults)%in%CowlitzNames,i]/(res$UM_ad[,colnames(res$Adults)%in%CowlitzNames,i]+res$M_ad[,colnames(res$Adults)%in%CowlitzNames,i]))
  LowerCowlitz_DIP_Adults<-apply(res$Adults[,colnames(res$Adults)%in%CowlitzNames,i],1,sum)
  LowerCowlitz_DIP_HOR_Adults<-apply(res$M_ad[,colnames(res$Adults)%in%CowlitzNames,i],1,sum)
  LowerCowlitz_DIP_pM<-LowerCowlitz_DIP_HOR_Adults/LowerCowlitz_DIP_Adults
  Cowlitz_pM<-apply(data.frame(LowerCowlitz_DIP_pM,pM),2,function(x)  c(quantile(x,c(0.025,0.25,0.5,0.75,0.975)),mean(x),sd(x)))
  Cowlitz_pM<-data.frame(t(Cowlitz_pM),i+2009)
  Cowlitz_pM$Population<-c("Lower Cowlitz DIP",CowlitzNames)
  colnames(Cowlitz_pM)[6:8]<-c("mean","sd","year")
  Cowlitz_Results<-rbind(Cowlitz_Results,Cowlitz_pM)
  rownames(Cowlitz_Results)<-NULL
}
write.csv(Cowlitz_Results,file.path(results.dir, subDir, paste0("Cowlitz_pM_2010_",2009+yrs,"_",Sys.Date(),".csv")),row.names = FALSE)

#weir efficiency
WC<-jagsdat$n1[colnames(res$Adults)%in%CowlitzNames[2:5],yr]
WC<-t(matrix(rep(WC,dim(sims[[1]])[1]),ncol=dim(sims[[1]])[1],nrow=4))
WE<-WC/res$UM_ad[,colnames(res$Adults)%in%CowlitzNames[2:5],yr]
WE<-apply(WE,2,function(x) c(quantile(x,c(0.025,0.25,0.5,0.75,0.975)),mean(x),sd(x)))
rownames(WE)[6:7]<-c("mean","sd")
WE<-t(WE)
rownames(WE)<-CowlitzNames[2:5]
write.csv(WE,file.path(results.dir, subDir, paste0("Cowlitz_Tribs_Weir_Efficiency_",2009+yrs,"_",Sys.Date(),".csv")))
```

## Main Model Tables
```{r}
#=============================
#new plots 12.16.2019
#====================
poporder<-unique(as.character(GRTSpops$TRT_Population))
poporder<-c(poporder[!poporder%in%c("",NA)],"WA LCR ESU")
TRT_miles<-data.frame(GRTSpops%>%group_by(TRT_Population)%>%summarise(TRT_F_miles=sum(F_miles)))
TRT_miles<-TRT_miles[!TRT_miles$TRT_Population%in%c("",NA),]
TRT_miles<-TRT_miles%>%group_by(TRT_Population)%>%adorn_totals("row",name="WA LCR ESU")

UM_ad_results<-data.frame(melt(apply(TRTresults$UM_ad,2:3,function(x) quantile(x,probs=c(0.025,0.25,0.5,0.75,0.975)))))
colnames(UM_ad_results)<-c("Quantile","Population","Year","UM_ad")
UM_ad_results<-UM_ad_results[!UM_ad_results$Population%in%c("",NA),]
UM_ad_results$Population<-as.character(UM_ad_results$Population)
UM_ESUtot<-data.frame(melt(apply(apply(TRTresults$UM_ad[,!dimnames(TRTresults$UM_ad)[[2]]%in%c("",NA),],c(1,3),sum),2,function(x) quantile(x,probs=c(0.025,0.25,0.5,0.75,0.975)))))
UM_ESUtot$Population<-"WA LCR ESU"
UM_ESUtot$Population<-as.character(UM_ESUtot$Population)
colnames(UM_ESUtot)<-c("Quantile","Year","UM_ad","Population")
UM_ad_results<-bind_rows(UM_ad_results,UM_ESUtot)
UM_ad_density_results<-merge(UM_ad_results,TRT_miles,by.x="Population",by.y="TRT_Population")
UM_ad_results<-UM_ad_results%>%spread(Quantile,UM_ad)
UM_ad_results$Origin<-"Wild"
UM_ad_density_results$Density<-UM_ad_density_results$UM_ad/(UM_ad_density_results$TRT_F_miles*1.60934)
UM_ad_density_results<-UM_ad_density_results%>%select(Population, Year, Quantile, Density)%>%spread(Quantile,Density)
UM_ad_density_results$Origin<-"Wild"

M_ad_results<-data.frame(melt(apply(TRTresults$M_ad,2:3,function(x) quantile(x,probs=c(0.025,0.25,0.5,0.75,0.975)))))
colnames(M_ad_results)<-c("Quantile","Population","Year","M_ad")
M_ad_results<-M_ad_results[!M_ad_results$Population%in%c("",NA),]
M_ad_results$Population<-as.character(M_ad_results$Population)
M_ESUtot<-data.frame(melt(apply(apply(TRTresults$M_ad[,!dimnames(TRTresults$M_ad)[[2]]%in%c("",NA),],c(1,3),sum),2,function(x) quantile(x,probs=c(0.025,0.25,0.5,0.75,0.975)))))
M_ESUtot$Population<-"WA LCR ESU"
M_ESUtot$Population<-as.character(M_ESUtot$Population)
colnames(M_ESUtot)<-c("Quantile","Year","M_ad","Population")
M_ad_results<-bind_rows(M_ad_results,M_ESUtot)
M_ad_density_results<-merge(M_ad_results,TRT_miles,by.x="Population",by.y="TRT_Population")
M_ad_results<-M_ad_results%>%spread(Quantile,M_ad)
M_ad_results$Origin<-"Hatchery"
M_ad_density_results$Density<-M_ad_density_results$M_ad/(M_ad_density_results$TRT_F_miles*1.60934)
M_ad_density_results<-M_ad_density_results%>%select(Population, Year, Quantile, Density)%>%spread(Quantile,Density)
M_ad_density_results$Origin<-"Hatchery"


pM_results<-melt(apply(TRTresults$pM,2:3,function(x) quantile(x,probs=c(0.025,0.25,0.5,0.75,0.975))))
colnames(pM_results)<-c("Quantile","Population","Year","pM")
pM_results<-pM_results[!pM_results$Population%in%c("",NA),]
pM_results$Population<-as.character(pM_results$Population)
M_ESUtot<-apply(TRTresults$M_ad[,!dimnames(TRTresults$M_ad)[[2]]%in%c("",NA),],c(1,3),sum)
UM_ESUtot<-apply(TRTresults$UM_ad[,!dimnames(TRTresults$UM_ad)[[2]]%in%c("",NA),],c(1,3),sum)
pM_ESUtot<-data.frame(melt(apply(M_ESUtot/(M_ESUtot+UM_ESUtot),2,function(x) quantile(x,probs=c(0.025,0.25,0.5,0.75,0.975)))))
pM_ESUtot$Population<-"WA LCR ESU"
pM_ESUtot$Population<-as.character(pM_ESUtot$Population)
colnames(pM_ESUtot)<-c("Quantile","Year","pM","Population")
pM_results<-bind_rows(pM_results,pM_ESUtot)
pM_results<-pM_results%>%spread(Quantile,pM)


Abundance_results<-data.frame(rbind(M_ad_results,UM_ad_results))

Density_results<-data.frame(rbind(M_ad_density_results,UM_ad_density_results))
write.csv(Density_results,file.path(results.dir,subDir,"Density_Results.csv"),)

Recovery_Goals<-data.frame(read.csv(paste(csv.data.dir,"TRT_Population_Goals.csv",sep="/")))

Abundance_results<-merge(Abundance_results,Recovery_Goals,by.x="Population",by.y="TRT_Population")

NOR<-data.frame(Abundance_results%>%filter(Origin=="Wild")%>%group_by(Population)%>%summarise(Recovery.Goal=max(Recovery.Goal),med=median(X50.),min=min(X50.),max=max(X50.)))
NOR_goal<-data.frame(Abundance_results%>%filter(Origin=="Wild" & X50.>Recovery.Goal)%>%count(Population))
NOR_Density<-data.frame(Density_results%>%filter(Origin=="Wild")%>%group_by(Population)%>%summarise(med.NOR_Density=median(X50.),min.NOR_Density=min(X50.),max.NOR_Density=max(X50.)))
HOR<-data.frame(Abundance_results%>%filter(Origin=="Hatchery")%>%group_by(Population)%>%summarise(med=median(X50.),min=min(X50.),max=max(X50.)))
pM<-data.frame(pM_results%>%group_by(Population)%>%summarise(med.PHOS=median(`50%`),min.pHOS=min(`50%`),max.pHOS=max(`50%`)))

Results_Table1<-merge(NOR,HOR,by="Population",suffixes = c(".NOR",".HOR"))
Results_Table1<-merge(Results_Table1,NOR_Density,by="Population")
Results_Table1<-merge(Results_Table1,pM,by="Population")
Results_Table1<-merge(Results_Table1,NOR_goal,all=TRUE)

Results_Table1%<>%
  as_tibble()%>%
  mutate(
    across(c(min.NOR,med.NOR,max.NOR,min.HOR,med.HOR,max.HOR),~round(.)),
    across(c(min.NOR_Density,med.NOR_Density,max.NOR_Density,min.pHOS,med.PHOS,max.pHOS),~round(.,2)),
    n=ifelse(is.na(n),0,n),
    prop_abv_goal = scales::percent(n/length(years)),
    range_NOR =paste0("(",min.NOR,"-",max.NOR,")"),
    range_NOR_density =paste0("(",min.NOR_Density,"-",max.NOR_Density,")"),
    range_HOR =paste0("(",min.HOR,"-",max.HOR,")"),
    range_pHOS =paste0("(",min.pHOS,"-",max.pHOS,")")
  )%>%
  dplyr::select(
    Population, Recovery.Goal,n,prop_abv_goal,med.NOR,range_NOR,med.NOR_Density,range_NOR_density,med.PHOS,range_pHOS,med.HOR,range_HOR
  )
    
write.csv(Results_Table1,file.path(results.dir,subDir,"Results_Table1.csv"),row.names = FALSE)
```


## Main Model Plots
```{r}
#unmarked plot
p<-ggplot(arrange(transform(UM_ad_results,Population=factor(Population,levels=poporder)),Population),aes_(x=as.name("Year"), y=as.name("X50."))) +
  geom_line(size=1)+
  geom_ribbon(aes_(ymin=as.name("X2.5."),ymax=as.name("X97.5.")), alpha=0.25) + 
  facet_wrap(~Population,scales="free") +
  aes(ymin=0) +
  labs(x="Year",y="Spawner Abundance") +
  scale_x_continuous(breaks = seq(min(UM_ad_results$Year), max(UM_ad_results$Year), by = 4)) +
  theme_bw()
  
print(p)
ggsave(file.path(results.dir,subDir,"UM_ad.png"),
       plot=p,
       width = 6.5, height = 6.5, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
       )

#unmarked and marked plot
p<-ggplot(arrange(transform(Abundance_results,Population=factor(Population,levels=poporder)),Population), aes_(x=as.name("Year"), y=as.name("X50."),color=as.name("Origin"))) +
  geom_line(size=1)+
  geom_ribbon(aes_(ymin=as.name("X2.5."),ymax=as.name("X97.5."),fill=as.name("Origin")), alpha=0.25,color=NA) + 
  facet_wrap(~Population,scales="free") +
  geom_hline(data = arrange(transform(Abundance_results,Population=factor(Population,levels=poporder))), aes(yintercept = Recovery.Goal,group = Population), size=1,linetype = "dashed",color="black")+
  aes(ymin=0) +
  labs(x="Year",y="Spawner Abundance") +
  scale_x_continuous(breaks = seq(min(Abundance_results$Year), max(Abundance_results$Year), by = 4)) +
  theme_bw()

print(p)
ggsave(file.path(results.dir,subDir,"Abundance.png"),
       plot=p,
       width = 6.5, height = 5, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
)

#phos plot
p<-ggplot(arrange(transform(pM_results,Population=factor(Population,levels=poporder)),Population), aes_(x=as.name("Year"), y=as.name("X50."))) +
  geom_line(size=1)+
  geom_ribbon(aes_(ymin=as.name("X2.5."),ymax=as.name("X97.5.")), alpha=0.25) + 
  facet_wrap(~Population) +
  aes(ymin=0,ymax=1) +
  labs(x="Year",y="Proportion Hatchery Origin Spawners") +
  scale_x_continuous(breaks = seq(min(pM_results$Year), max(pM_results$Year), by = 4)) +
  theme_bw()

print(p)
ggsave(file.path(results.dir,subDir,"pM.png"),
       plot=p,
       width = 6.5, height = 6.5, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
)



Bradford2000=tibble(
  values = c(3.9, 19, 44) * median(res$mu_pF),
  `Bradford et al. (2000) N*` = c("min","mean","max")
  )

#density plot
p<-ggplot(arrange(transform(Density_results,Population=factor(Population,levels=poporder)),Population),aes_(x=as.name("Year"), y=as.name("X50."),color=as.name("Origin"))) +
  geom_line(size=1)+
  facet_wrap(~Population) + #,scales ="free"
  geom_ribbon(aes_(ymin=as.name("X2.5."),ymax=as.name("X97.5."),fill=as.name("Origin")), alpha=0.25,color=NA) + 
  #ylim(0.0,200) +
  # #scale_y_log10(breaks=c(0.001,0.01,0.1,1,10,100),labels=c(0.001,0.01,0.1,1,10,100),limits = c(.001,200),expand=c(0,0)) +
  # #scale_y_log10()+
  scale_y_log10(limits = c(0.001, 200),
                labels = trans_format("log10", math_format(10^.x)),
                breaks=trans_breaks("log10", function(x) 10^x, n=4)) +
  theme_bw() +
  theme(panel.grid.minor = element_line(color="grey80", linetype="solid"), panel.grid.major = element_line(color="grey80", linetype="solid")) +
  annotation_logticks(base = 10)+
  scale_x_continuous(breaks = seq(min(Density_results$Year), max(Density_results$Year), by = 4)) +
  geom_hline(data=Bradford2000,mapping=aes(yintercept=values,linetype=`Bradford et al. (2000) N*`)) +
  coord_cartesian(ylim = c(0.1,200))+ 
  theme_bw()+
  labs(x="Year",y="Spawners per Km")

print(p)
ggsave(file.path(results.dir,subDir,"Density.png"),
       plot=p,
       width = 6.5, height = 5, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
)

#
Recovery_Goals<-merge(Recovery_Goals,TRT_miles)
Recovery_Goals<-Recovery_Goals[!is.na(Recovery_Goals$Recovery.Goal) & Recovery_Goals$TRT_Population!="WA LCR ESU",]
Recovery_Goals$Recovery.Goal<-as.numeric(Recovery_Goals$Recovery.Goal)
p<-ggplot(Recovery_Goals,aes(x=TRT_F_miles*1.60934, y=Recovery.Goal,color=Recovery.Designation)) +
   geom_point(size=2)+
  labs(x="Estimated Habitat Extent (km)",y="Recovery Goal") +
  #scale_y_log10()+
  #scale_x_log10()+
  aes(ymin=100) +
  theme_classic()

print(p)
ggsave(file.path(results.dir,subDir,"Recovery Goal vs Kilometers.png"),
       plot=p,
       width = 4, height = 3, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
)



logit<-function(x){log(x/(1-x))}
ilogit<-function(x){exp(x)/(1+exp(x))}
hier_pF<-ilogit(rnorm(6400,logit(res$mu_pF),res$sigma_pF))
params<-data.frame(matrix(c(
quantile(res$RpF,c(0.025,0.25,0.5,0.75,0.975))
,quantile(hier_pF,c(0.025,0.25,0.5,0.75,0.975))
),nrow = 5,ncol=2)
)

library(RColorBrewer)
cols<-brewer.pal(n=2,name = "Pastel1")
# par(mfrow=c(3,1),mar=c(2,10,2,5))
# boxplot(params[,1],outline=F,horizontal = T,boxwex = rep(0.5,3),las=1,yaxt="n", boxfill=cols[1],ylim=c(0,1))
# axis(2,at=c(1:3),labels = c("Redds Per Female", "Redds per Female", "rho"),las=2)
# boxplot(params[,2],outline=F,horizontal = T,boxwex = rep(0.5,3),las=1,yaxt="n", boxfill=cols[2],ylim=c(0,1))
# axis(2,at=c(1:3),labels = c("Proportion Female", "Redds per Female", "rho"),las=2)
# boxplot(params[,3],outline=F,horizontal = T,boxwex = rep(0.5,3),las=1,yaxt="n", boxfill=cols[3],ylim=c(0,1))
# axis(2,at=c(1:3),labels = c("rho", "Redds per Female", "rho"),las=2)


# par(mfrow=c(3,1),mar=c(2,10,2,5))
# boxplot(params[,1],outline=F,horizontal = T,boxwex = rep(0.5,3),las=1,yaxt="n", boxfill=cols[1],ylim=c(0,1))
# axis(2,at=c(1:3),labels = c("Redds Per Female", "Redds per Female", "rho"),las=2)
# matplot(apply(jagsfit$BUGSoutput$sims.list$pF,3L,c))
# axis(2,at=c(1:3),labels = c("Proportion Female", "Redds per Female", "rho"),las=2)
# boxplot(params[,3],outline=F,horizontal = T,boxwex = rep(0.5,3),las=1,yaxt="n", boxfill=cols[3],ylim=c(0,1))
# axis(2,at=c(1:3),labels = c("rho", "Redds per Female", "rho"),las=2)



dimnames(res$pF)[[3]]<-years
df<-data.frame(melt(res$pF))%>%
  dplyr::rename(pF=value,Year=Var.3,GRTS_Population = Var.2)
hier_pF<-data.frame(hier_pF)
hier_pF$GRTS_Population<-"hier_pF"


p<-ggplot(data = df, aes(x=pF, group=GRTS_Population)) + 
  geom_density(alpha = 0.1,fill='black', linetype='blank') +
  theme_bw()+
  geom_density(data=hier_pF,mapping=aes(x=hier_pF),alpha = 1,linetype='solid',color=rgb(0.2,0.2,0.6,1),size=1.25)+
  labs(x="Proportion of Females",y="Kernel Density") 
  #aes(xmin=0.25,xmax=0.75) 

  RpF <- data.frame(res$RpF)%>%
    dplyr::rename(RpF=res.RpF)
  
  p2<-ggplot(data = RpF)+ 
    geom_density(aes(x=RpF),alpha = 0.4,fill='black') +
    theme_bw()+
    #geom_density(data=hier_pF,aes(x=hier_pF),alpha = 1,linetype='solid',color=cols[1],size=1.25)+
    labs(x="Redds per Female",y="Kernel Density")
    #aes(xmin=0,xmax=1) 


p3<-grid.arrange(p, p2, nrow = 1)
ggsave(file.path(results.dir,subDir,"RpF_pF.png"),
       plot=p3,
       width = 6.5, height = 3, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
)



Abundance_corr_dat<-Abundance_results%>%
  filter(Origin=="Wild", Population!="WA LCR ESU")%>%
  dplyr::select(Population,Year,X50.)%>%
  pivot_wider(names_from = Population,values_from = X50.)%>%
  arrange(Year)%>%
  dplyr::select(-Year)
  
corrplot<-Abundance_corr_dat%>%  
  cor()%>%
  ggcorrplot(hc.order = TRUE, type = "lower", outline.col = "white", p.mat = NULL, sig.level = 0.05, lab_size = 1.5)


Abundance_corr<-Abundance_corr_dat%>%
  cor()%>%
  round(.,2)%>%
  data.frame()%>%
  rownames_to_column(var="Population")%>%
  as_tibble()

corr_rank_plot<-Abundance_corr %>%
  pivot_longer(names_to = "corr_pop", values_to = "corr", cols = c(-Population)) %>%
  group_by(Population) %>%
  summarise(mean_correlation = mean(corr)) %>%
  arrange(desc(mean_correlation)) %>%
  mutate(Population = factor(Population, levels = Population)) %>%  # Reorder levels based on mean correlation
  ggplot(aes(y = mean_correlation, x = Population)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(y = "Mean Pairwise Correlation", x = "Population") +
  coord_flip() +
  theme_minimal()+
  theme(
    text = element_text(size = 14)
  )


pop_process_sd_plot<-apply(res$sigma_lambda,2,function(x) c("mean"=mean(x),"sd"=sd(x),quantile(x,c(0.025,0.25,0.5,0.75,0.975))))%>%
  data.frame()%>%
  rownames_to_column(var="parameter")%>%
  as_tibble()%>%
  pivot_longer(cols = -parameter, names_to = "column", values_to = "value")%>%
  pivot_wider(names_from = parameter,values_from = value)%>%
  bind_cols(sub_population=rownames(jagsdat$Y))%>%
  dplyr::select(sub_population,population_process_error_SD=`50%`)%>%
  arrange(population_process_error_SD)%>%
  ggplot(aes(y =population_process_error_SD, x =reorder(sub_population, population_process_error_SD))) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(y = "Population Process Error SD", x = "Sub-population")+
  coord_flip() +
  theme_minimal()+
  theme(
    text = element_text(size = 14)
  )

ESU_process_var_prop_plot<-apply(median(res$sigma_lambda_all)^2/(res$sigma_lambda^2+median(res$sigma_lambda_all)^2),2,function(x) c("mean"=mean(x),"sd"=sd(x),quantile(x,c(0.025,0.25,0.5,0.75,0.975))))%>%
  data.frame()%>%
  rownames_to_column(var="parameter")%>%
  as_tibble()%>%
  pivot_longer(cols = -parameter, names_to = "column", values_to = "value")%>%
  pivot_wider(names_from = parameter,values_from = value)%>%
  bind_cols(sub_population=rownames(jagsdat$Y))%>%
  dplyr::select(sub_population,ESU_process_var_proportion=`50%`)%>%
  arrange(ESU_process_var_proportion)%>%
  ggplot(aes(y =ESU_process_var_proportion, x =reorder(sub_population, ESU_process_var_proportion))) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(y = "Proportion Process Variance ESU-scale", x = "Sub-population")+
  coord_flip() +
  theme_minimal()+
  theme(
    text = element_text(size = 14)
  )
  



panel_labels<-c(letters[1:4])

p3<-grid.arrange(
  arrangeGrob(
    pop_process_sd_plot,
    top = grid::textGrob(paste0("(",panel_labels[1],")"), x = 0.05, y = 0.95, just = c("left", "top"), gp = grid::gpar(fontsize = 16))
    ), 
  arrangeGrob(
    ESU_process_var_prop_plot,
    top = grid::textGrob(paste0("(",panel_labels[2],")"), x = 0.05, y = 0.95, just = c("left", "top"), gp = grid::gpar(fontsize = 16))
    ),
  arrangeGrob(
    corrplot,
    top = grid::textGrob(paste0("(",panel_labels[3],")"), x = 0.05, y = 0.95, just = c("left", "top"), gp = grid::gpar(fontsize = 16))
    ), 
  arrangeGrob(
    corr_rank_plot,
    top = grid::textGrob(paste0("(",panel_labels[4],")"), x = 0.05, y = 0.95, just = c("left", "top"), gp = grid::gpar(fontsize = 16))
    ), 
  nrow = 2
)
  
ggsave(file.path(results.dir,subDir,"abundance_corr_plot.png"),
       plot=p3,
       width = 8, height = 8, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
)


trends<-res$eps_lambda%>%
  reshape2::melt()%>%
  setNames(c("iteration","Year","GRTS_Population","eps_lambda"))%>%
  mutate(GRTS_Population=as.character(GRTS_Population))%>%
  bind_rows(res$eps_lambda_all%>%
              reshape2::melt()%>%
              setNames(c("iteration","Year","eps_lambda"))%>%
              mutate(GRTS_Population="WA LCR ESU")
      
  )%>%
  mutate(Year=Year+min(years))%>%
  arrange(GRTS_Population,iteration,Year)%>%
  group_by(GRTS_Population,iteration)%>%
  mutate(trend=cumsum(eps_lambda))%>%
  group_by(GRTS_Population,Year)%>%
  summarise(mean=mean(trend),
            sd=sd(trend),
            `2.5%` = quantile(trend,0.025),
            `25%` = quantile(trend,0.25),
            `50%` = quantile(trend,0.5),
            `75%` = quantile(trend,0.75),
            `97.5%` = quantile(trend,0.975)
  )%>%
  bind_rows(expand_grid(Year=years[1],GRTS_Population=c(1:pops[1], "WA LCR ESU"),mean=0,sd=0,`2.5%`=0,`25%`=0,`50%`=0,`75%`=0,`97.5%`=0))%>%
  mutate(group=ifelse(GRTS_Population=="WA LCR ESU","WA LCR ESU","Sub-population"))%>%
  arrange(GRTS_Population,Year)

ribbon_data <- trends %>%
  filter(GRTS_Population == "WA LCR ESU")


ESU_and_GRTS_Population_Plot<-ggplot(trends,aes(x=Year,y=`50%`,color=GRTS_Population,group)
       )+
  facet_wrap(~group,nrow=2)+
  geom_ribbon(data=ribbon_data,aes(ymin=`2.5%`,ymax=`97.5%`,fill=GRTS_Population),alpha=0.5,color=NA)+
  geom_ribbon(data=ribbon_data,aes(ymin=`25%`,ymax=`75%`,fill=GRTS_Population),alpha=0.5,color=NA)+
  geom_line(aes(color=GRTS_Population))+
  scale_x_continuous(breaks = seq(min(trends$Year), max(trends$Year), by = 2))+
  theme_bw()+
  theme(legend.position = "none",
        text = element_text(size = 14)
        )+
  ylab("Scaled log trend")+
  geom_hline(yintercept = 0)


ggsave(file.path(results.dir,subDir,"abundance_trend_plot.png"),
       plot=ESU_and_GRTS_Population_Plot,
       width = 6.5, height = 4, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
)

ESU_Trend_Plot<-ggplot(trends%>%
             filter(GRTS_Population=="WA LCR ESU")
             ,aes(x=Year,y=`50%`,color=GRTS_Population,group)
       )+
  geom_ribbon(data=ribbon_data,aes(ymin=`2.5%`,ymax=`97.5%`,fill=GRTS_Population),alpha=0.5,color=NA)+
  geom_ribbon(data=ribbon_data,aes(ymin=`25%`,ymax=`75%`,fill=GRTS_Population),alpha=0.5,color=NA)+
  geom_line(aes(color=GRTS_Population))+
  scale_x_continuous(breaks = seq(min(trends$Year), max(trends$Year), by = 2))+
  theme_bw()+
  theme(legend.position = "none",
        text = element_text(size = 14)
        )+
  ylab("Scaled log ESU-level trend")+
  geom_hline(yintercept = 0)

GRTS_Population_Trend_Plot<-ggplot(trends%>%
             filter(GRTS_Population!="WA LCR ESU")
             ,aes(x=Year,y=`50%`,color=GRTS_Population,group)
       )+
  geom_line(aes(color=GRTS_Population))+
  scale_x_continuous(breaks = seq(min(trends$Year), max(trends$Year), by = 2))+
  theme_bw()+
  theme(legend.position = "none",
        text = element_text(size = 14)
        )+
  ylab("Scaled log Sub-population trends")+
  geom_hline(yintercept = 0)



panel_labels<-c(letters[1:6])

p7<-grid.arrange(
  arrangeGrob(
    ESU_Trend_Plot,
    top = grid::textGrob(paste0("(",panel_labels[1],")"), x = 0.05, y = 0.95, just = c("left", "top"), gp = grid::gpar(fontsize = 16))
    ), 
   arrangeGrob(
    GRTS_Population_Trend_Plot,
    top = grid::textGrob(paste0("(",panel_labels[2],")"), x = 0.05, y = 0.95, just = c("left", "top"), gp = grid::gpar(fontsize = 16))
    ), 
  arrangeGrob(
    pop_process_sd_plot,
    top = grid::textGrob(paste0("(",panel_labels[3],")"), x = 0.05, y = 0.95, just = c("left", "top"), gp = grid::gpar(fontsize = 16))
    ), 
  arrangeGrob(
    ESU_process_var_prop_plot,
    top = grid::textGrob(paste0("(",panel_labels[4],")"), x = 0.05, y = 0.95, just = c("left", "top"), gp = grid::gpar(fontsize = 16))
    ),
  arrangeGrob(
    corrplot,
    top = grid::textGrob(paste0("(",panel_labels[5],")"), x = 0.05, y = 0.95, just = c("left", "top"), gp = grid::gpar(fontsize = 16))
    ), 
  arrangeGrob(
    corr_rank_plot,
    top = grid::textGrob(paste0("(",panel_labels[6],")"), x = 0.05, y = 0.95, just = c("left", "top"), gp = grid::gpar(fontsize = 16))
    ), 
  nrow = 3
)
  
ggsave(file.path(results.dir,subDir,"abundance_corr_plot_6panel.png"),
       plot=p7,
       width = 6.5, height = 9, dpi = 300, limitsize = TRUE,
       scale=1.75,
       units = c("in")
)


```



# To-Do List
This section lists future possible code upgrades

Higher Priority
1. consider other RpF parameterizations
2. Check effects of fixed reach LAB in 2014 and 2017...right now all its data is in  the lower cowlitz and not split with Lacamas
3. apply index sex ratio and mark status to adults separately!
4. apply phos at the reach scale
5. change process error variance to be pop specific for PM

Lower priority
6. decide if nest pops effect on RpF and neg bin shape params
7. ADD IN wind/upper gorge
8. see if we can get Cedar Creek MR data fixed
9. deal with bias of missed surveys 
10. Grays surveys are count only so double counting index redds!!!!
11. mainstem nf lewis, toutle, cowlitz missing
12. MAG redd sch. info 2010-2012; tiugh may not be possible
